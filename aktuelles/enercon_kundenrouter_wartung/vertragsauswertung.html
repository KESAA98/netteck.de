<div class="vz-wrapper">

    <!-- Titel -->
    <h2 class="vz-title">
        Anfrage<br>
        <span>Wartungs- &amp; Servicevertrag</span>
    </h2>

    <!-- Fake-Innenbereich (nur Optik) â€“ Drop-Zone ist die komplette vz-wrapper -->
    <div id="vz-drop-area" class="vz-drop-area">
        <div class="vz-drop-inner">

            <p class="vz-intro-line">
                Hier kÃ¶nnen Sie Ihren eigenen Wartungs- &amp; Servicevertrag anfragen.
            </p>

            <img src="/Logos/dad.png" alt="PDF Icon" class="vz-intro-icon">

            <p class="vz-intro-text">
                Laden Sie einfach die Rechnung als PDF fÃ¼r den von
                <strong>Kevin Strakerjahn Networks &amp; Automation</strong>
                eingebauten Router hier hoch. Die PDF wird automatisch analysiert â€“ im Anschluss
                kÃ¶nnen Sie fehlende Angaben ergÃ¤nzen.
            </p>

            <p class="vz-drop-hint">
                Es kann genau <strong>eine</strong> PDF-Datei hochgeladen werden.
                Datei einfach hier hineinziehen oder klicken.
            </p>

        </div>

        <!-- unsichtbarer echter File-Input -->
        <input type="file" id="vz-file-input" accept="application/pdf" hidden>
    </div>

    <!-- Datei-Anzeige -->
    <div id="vz-file-row" class="vz-file-row" style="display:none;">
        <div class="vz-file-info">
            <span class="vz-file-icon">ðŸ“„</span>
            <span id="vz-file-name" class="vz-file-name"></span>
        </div>
        <button id="vz-file-remove" class="vz-file-remove" type="button">ðŸ—‘</button>
    </div>

    <!-- Datenschutz -->
    <div id="vz-legal" class="vz-legal" style="display:none;">
        <label class="vz-check-label">
            <input type="checkbox" id="vz-accept">
            <span>
                Ich akzeptiere die
                <a href="/datenschutz" target="_blank">DatenschutzerklÃ¤rung</a> und
                <a href="/agb" target="_blank">AGBs</a>.
            </span>
        </label>
    </div>

    <!-- PrÃ¼fen -->
    <div id="vz-check-area" class="vz-check-area" style="display:none;">
        <button id="vz-check-btn" class="vz-btn" type="button" disabled>PrÃ¼fen</button>
    </div>

    <!-- Loading -->
    <div id="vz-wait" class="vz-wait" style="display:none;">
        <div class="vz-spinner"></div>
        <p>Die Rechnung wird geprÃ¼ft. Dies kann 10â€“30 Sekunden dauernâ€¦</p>
    </div>

    <!-- Analyse-Ergebnis -->
    <div id="vz-result" class="vz-result" style="display:none;"></div>

</div>

<style>
/* gesamter Container â†’ jetzt voll ohne Padding auÃŸen */
.service-card#vertragsauswertung {
    padding: 0;
}

/* Ã„UÃŸERE gestrichelte Linie â€“ ohne Radius */
.vz-wrapper {
    margin: 0;
    padding: 16px;
    font-size: 0.95rem;
    box-sizing: border-box;

    border: 2px dashed #cbd5e1;
    border-radius: 0;

    background: #f8fafc;
    min-height: 100%;

    display: flex;
    flex-direction: column;
    gap: 14px;
}

.vz-wrapper.vz-dragover {
    border-color: var(--primary);
    background: #e8f1ff;
}

/* Titel */
.vz-title {
    text-align: center;
    margin: 0;
    margin-bottom: 4px;
    font-size: 1.2rem;
    font-weight: 700;
    line-height: 1.35;
    color: var(--text-main);
}

/* INNERER optischer Bereich */
.vz-drop-area {
    background: #e7ebef;
    border-radius: 20px;
    padding: 20px 14px;
}

.vz-drop-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.vz-intro-line {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.vz-intro-icon {
    width: 58px;
    height: auto;
    margin: 4px 0;
}

.vz-intro-text {
    margin: 0;
    text-align: center;
    line-height: 1.45;
    font-size: 0.92rem;
}

.vz-drop-hint {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 4px;
}

/* Datei-Zeile */
.vz-file-row {
    padding: 10px 12px;
    border-radius: 12px;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;

    display: flex;
    justify-content: space-between;
    align-items: center;
}

.vz-file-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.vz-file-icon {
    font-size: 1.1rem;
}

.vz-file-name {
    font-weight: 600;
    max-width: 180px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

.vz-file-remove {
    background: transparent;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    color: #b91c1c;
}

/* LEGAL */
.vz-legal {
    font-size: 0.85rem;
    margin-top: -4px;
}

.vz-check-label {
    display: flex;
    gap: 8px;
    align-items: flex-start;
}

.vz-check-label a {
    text-decoration: underline;
    color: var(--text-main);
}

/* PrÃ¼fen Button */
.vz-check-area {
    text-align: right;
}

.vz-btn {
    padding: 8px 16px;
    border-radius: 999px;
    background: var(--primary);
    border: none;
    color: white;
    font-size: 0.9rem;
    cursor: pointer;
}

.vz-btn:disabled {
    background: #bcd4ff;
}

/* Loading */
.vz-wait {
    text-align: center;
    font-size: 0.88rem;
    color: #475569;
}

.vz-spinner {
    width: 28px;
    height: 28px;
    border-radius: 999px;
    border: 3px solid #dbeafe;
    border-top-color: var(--primary);
    margin: 0 auto 8px;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Ergebnis */
.vz-result {
    background: #f1f5f9;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid #e2e8f0;
    font-size: 0.85rem;
}

.vz-result table {
    width: 100%;
    border-collapse: collapse;
}

.vz-result td {
    padding: 4px 2px;
    border-bottom: 1px solid #e2e8f0;
}

.vz-result tr:last-child td {
    border-bottom: none;
}

.vz-result input.vz-edit {
    width: 100%;
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #cbd5e1;
    font-size: 0.82rem;
}

.vz-error {
    color: #b91c1c;
    font-weight: 600;
}
</style>

<script>
(function () {
    "use strict";

    const wrapper   = document.querySelector(".vz-wrapper");
    const dropArea  = document.getElementById("vz-drop-area");
    const fileInput = document.getElementById("vz-file-input");

    const fileRow   = document.getElementById("vz-file-row");
    const fileName  = document.getElementById("vz-file-name");
    const removeBtn = document.getElementById("vz-file-remove");

    const legalBox  = document.getElementById("vz-legal");
    const checkArea = document.getElementById("vz-check-area");
    const checkBtn  = document.getElementById("vz-check-btn");
    const acceptChk = document.getElementById("vz-accept");

    const waitBox   = document.getElementById("vz-wait");
    const resultBox = document.getElementById("vz-result");

    let selectedFile = null;
    let parsedData   = null;
    let overlaySent  = false;

    /* ========== DRAG & DROP auf gesamte FlÃ¤che ========== */

    wrapper.addEventListener("dragover", (e) => {
        e.preventDefault();
        wrapper.classList.add("vz-dragover");
    });

    wrapper.addEventListener("dragleave", (e) => {
        if (!wrapper.contains(e.relatedTarget)) {
            wrapper.classList.remove("vz-dragover");
        }
    });

    wrapper.addEventListener("drop", (e) => {
        e.preventDefault();
        wrapper.classList.remove("vz-dragover");

        if (e.dataTransfer.files[0]) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    dropArea.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => {
        if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    /* ========== Datei laden ========== */

    function handleFile(file) {
        if (file.type !== "application/pdf") {
            alert("Bitte nur PDF-Dateien hochladen.");
            return;
        }

        selectedFile = file;
        parsedData = null;
        overlaySent = false;

        fileName.textContent = file.name;
        fileRow.style.display = "flex";

        legalBox.style.display = "block";
        checkArea.style.display = "block";
        acceptChk.checked = false;
        checkBtn.disabled = true;

        waitBox.style.display = "none";
        resultBox.style.display = "none";
    }

    removeBtn.addEventListener("click", () => {
        selectedFile = null;
        parsedData = null;
        overlaySent = false;

        fileRow.style.display = "none";
        legalBox.style.display = "none";
        checkArea.style.display = "none";
        resultBox.style.display = "none";
        waitBox.style.display = "none";

        acceptChk.checked = false;
        checkBtn.disabled = true;
    });

    acceptChk.addEventListener("change", () => {
        checkBtn.disabled = !(
            acceptChk.checked &&
            selectedFile
        );
    });

    /* ========== PrÃ¼fen klicken ========== */

    checkBtn.addEventListener("click", async () => {
        if (!selectedFile) return;

        checkArea.style.display = "none";
        legalBox.style.display = "none";
        fileRow.style.display = "none";
        resultBox.style.display = "none";

        waitBox.style.display = "block";

        const base64 = await toBase64(selectedFile);

        const payload = {
            fileName: selectedFile.name,
            fileContent: base64
        };

        let res, json;
        try {
            res = await fetch(
                "https://default91b0e232846941aab7d1176f14ecb7.8c.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/740a58efef1a4952af4c7e05e0ddea74/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=gsPq8vYpfRdArQN6KQdM1FDGilRliBu9VFrMcAYi3iQ",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                }
            );

            json = await res.json();
        } catch (err) {
            showError("Fehler bei der Analyse.");
            return;
        }

        let body = json;
        if (json && typeof json === "object" && "body" in json) {
            if (typeof json.body === "string") {
                try { body = JSON.parse(json.body); } catch {}
            } else body = json.body;
        }

        parsedData = body;
        waitBox.style.display = "none";
        fileRow.style.display = "flex";

        if (!body || body.ist_router_einbau_rechnung === false) {
            showError("Rechnung nicht erkannt.");
            return;
        }

        renderTable(body);
        autoOpenIfComplete();
    });

    /* ========== Base64 ========== */
    function toBase64(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.onload = () => {
                res(reader.result.split(",")[1]);
            };
            reader.readAsDataURL(file);
        });
    }

    /* ========== Fehlermeldung anzeigen ========== */
    function showError(msg) {
        resultBox.innerHTML = `<p class="vz-error">${msg}</p>`;
        resultBox.style.display = "block";
    }

    /* ========== Tabelle generieren ========== */
    function renderTable(data) {
        let html = "<table>";

        for (let key in data) {
            if (key === "ist_router_einbau_rechnung") continue;

            const label = key === "windpark_nummer"
                ? "Windpark ID"
                : key === "windpark_name"
                ? "Windpark"
                : key.replace(/_/g, " ");

            const val = data[key];
            const editable = val === null || val === "";

            html += `
                <tr>
                    <td><strong>${label}:</strong></td>
                    <td>
                        ${
                            editable
                                ? `<input class="vz-edit" data-k="${key}" placeholder="Bitte ergÃ¤nzen">`
                                : val
                        }
                    </td>
                </tr>
            `;
        }

        html += "</table>";
        resultBox.innerHTML = html;
        resultBox.style.display = "block";

        resultBox.querySelectorAll(".vz-edit").forEach(inp => {
            inp.addEventListener("input", () => {
                parsedData[inp.dataset.k] = inp.value;
                autoOpenIfComplete();
            });
        });
    }

    /* ========== PrÃ¼fen ob alle Felder gesetzt â†’ Overlay Ã¶ffnen ========== */
    function autoOpenIfComplete() {
        if (overlaySent) return;
        if (!parsedData) return;

        for (let key in parsedData) {
            if (key === "ist_router_einbau_rechnung") continue;
            if (!parsedData[key]) return;
        }

        overlaySent = true;
        if (typeof openOverlay === "function") openOverlay();
        if (typeof loadSection === "function") loadSection("vertragsvorlage", "vertragsvorlage.html");
    }

})();
</script>
