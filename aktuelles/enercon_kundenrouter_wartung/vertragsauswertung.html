<div class="vz-wrapper">

    <!-- Titel zentriert -->
    <h2 class="vz-title">
        Anfrage<br>
        <span>Wartungs- &amp; Servicevertrag</span>
    </h2>

    <!-- Drag & Drop ‚Äì optisches Feld, technisch ist der ganze Container Drop-Zone -->
    <div id="vz-drop-area" class="vz-drop-area">
        <div class="vz-drop-inner">
            <div class="vz-pdf-icon">üìÑ</div>
            <div class="vz-drop-headline">Rechnung f√ºr den Routereinbau hochladen</div>
            <div class="vz-drop-text">
                Laden Sie die Schluss- oder Abschlagsrechnung f√ºr den LANCOM-Routereinbau
                als PDF-Datei hoch. Die Rechnung wird automatisch analysiert, um
                Firmendaten, Windpark-ID, Windparkname und Rechnungsangaben auszulesen.
            </div>
            <div class="vz-drop-text">
                Im Anschluss k√∂nnen Sie fehlende Angaben direkt erg√§nzen und auf Basis
                dieser Daten eine beispielhafte Vertrags√ºbersicht mit Preisstruktur anzeigen lassen.
            </div>
            <div class="vz-drop-hint">
                Es kann genau <strong>eine</strong> PDF-Datei hochgeladen werden.
                Ziehen Sie die Datei einfach in diesen Bereich oder klicken Sie hier, um sie auszuw√§hlen.
            </div>
        </div>
        <input type="file" id="vz-file-input" accept="application/pdf" hidden>
    </div>

    <!-- Dateizeile (unter dem Titel, nach Auswahl und nach Pr√ºfung sichtbar) -->
    <div id="vz-file-row" class="vz-file-row" style="display:none;">
        <div class="vz-file-info">
            <span class="vz-file-icon">üìÑ</span>
            <span id="vz-file-name" class="vz-file-name"></span>
        </div>
        <button id="vz-file-remove" class="vz-file-remove" type="button" aria-label="Datei entfernen">üóë</button>
    </div>

    <!-- Datenschutz / AGB + Pr√ºfen -->
    <div id="vz-legal" class="vz-legal" style="display:none;">
        <label class="vz-check-label">
            <input type="checkbox" id="vz-accept">
            <span>
                Ich akzeptiere die
                <a href="/datenschutz" target="_blank">Datenschutzerkl√§rung</a> und
                <a href="/agb" target="_blank">AGBs</a>.
            </span>
        </label>
    </div>

    <div id="vz-check-area" class="vz-check-area" style="display:none;">
        <button id="vz-check-btn" class="vz-btn" type="button" disabled>Pr√ºfen</button>
    </div>

    <!-- Ladezustand -->
    <div id="vz-wait" class="vz-wait" style="display:none;">
        <div class="vz-spinner"></div>
        <p>
            Ihre Rechnung wird gepr√ºft. Dies kann je nach Dateigr√∂√üe und Systemauslastung
            ungef√§hr 10‚Äì30&nbsp;Sekunden dauern.
        </p>
    </div>

    <!-- Ergebnis-Tabelle -->
    <div id="vz-result" class="vz-result" style="display:none;"></div>

</div>

<style>
    .vz-wrapper {
        margin: 0;
        padding: 12px 14px 14px 14px; /* innen Abstand, au√üen keiner */
        font-size: 0.95rem;
        box-sizing: border-box;
        border-radius: 18px;
        border: 2px dashed #d1d5db;   /* Fake-Drop-Rahmen f√ºr den ganzen Container */
        background: #f8fafc;
        min-height: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .vz-wrapper.vz-dragover {
        border-color: var(--primary);
        background: #e5f0ff;
    }

    .vz-title {
        text-align: center;
        margin: 0;
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--text-main);
        line-height: 1.3;
    }

    .vz-title span {
        font-weight: 600;
    }

    /* Optisches inneres Drag-Feld ‚Äì nur Fake */
    .vz-drop-area {
        margin-top: 8px;
        border-radius: 12px;
        background: #edf2f7;
        padding: 14px 10px;
        text-align: center;
    }

    .vz-drop-inner {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
    }

    .vz-pdf-icon {
        font-size: 2.1rem;
        margin-bottom: 4px;
    }

    .vz-drop-headline {
        font-weight: 600;
        color: var(--text-main);
    }

    .vz-drop-text {
        font-size: 0.9rem;
        color: var(--text-main);
        line-height: 1.4;
    }

    .vz-drop-hint {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    /* Dateizeile */
    .vz-file-row {
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
    }

    .vz-file-info {
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 0;
    }

    .vz-file-icon {
        font-size: 1.1rem;
    }

    .vz-file-name {
        font-weight: 600;
        color: #374151;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .vz-file-remove {
        border: none;
        background: transparent;
        cursor: pointer;
        color: #c53030;
        font-size: 1.1rem;
    }

    /* Datenschutz / Pr√ºfen */
    .vz-legal {
        margin-top: 8px;
        font-size: 0.85rem;
    }

    .vz-check-label {
        display: flex;
        gap: 6px;
        align-items: flex-start;
        cursor: pointer;
    }

    .vz-check-label input {
        margin-top: 2px;
    }

    .vz-check-label a {
        text-decoration: underline;
    }

    .vz-check-area {
        margin-top: 6px;
        text-align: right;
    }

    .vz-btn {
        padding: 7px 14px;
        border-radius: 999px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
    }

    .vz-btn:disabled {
        background: #bcd4ff;
        cursor: not-allowed;
    }

    /* Warten / Spinner */
    .vz-wait {
        margin-top: 12px;
        text-align: center;
        font-size: 0.85rem;
        color: #4b5563;
        padding: 10px 4px 6px 4px;
    }

    .vz-spinner {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        border: 3px solid #e5e7eb;
        border-top-color: var(--primary);
        margin: 0 auto 8px;
        animation: vz-spin 0.8s linear infinite;
    }

    @keyframes vz-spin {
        to { transform: rotate(360deg); }
    }

    /* Ergebnis-Tabelle */
    .vz-result {
        margin-top: 10px;
        padding: 8px 4px 4px 4px;
        font-size: 0.85rem;
        background: #f9fafb;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
    }

    .vz-result table {
        width: 100%;
        border-collapse: collapse;
    }

    .vz-result td {
        padding: 3px 2px;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: top;
    }

    .vz-result tr:last-child td {
        border-bottom: none;
    }

    .vz-result strong {
        font-weight: 600;
    }

    .vz-result input.vz-edit {
        width: 100%;
        padding: 3px 4px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        font-size: 0.8rem;
    }

    .vz-error {
        color: #b91c1c;
        font-size: 0.85rem;
    }
</style>

<script>
(function () {
    "use strict";

    const container   = document.querySelector(".vz-wrapper");  // ganze Karte ist Drop-Zone
    const dropArea    = document.getElementById("vz-drop-area");
    const fileInput   = document.getElementById("vz-file-input");
    const fileRow     = document.getElementById("vz-file-row");
    const fileNameEl  = document.getElementById("vz-file-name");
    const fileRemove  = document.getElementById("vz-file-remove");

    const legalBox    = document.getElementById("vz-legal");
    const acceptCheck = document.getElementById("vz-accept");
    const checkArea   = document.getElementById("vz-check-area");
    const checkBtn    = document.getElementById("vz-check-btn");

    const waitBox     = document.getElementById("vz-wait");
    const resultBox   = document.getElementById("vz-result");

    if (!container || !dropArea || !fileInput) {
        console.error("vertragsauswertung.html: wichtige Elemente fehlen.");
        return;
    }

    let selectedFile = null;
    let resultBody   = null;
    let overlayOpened = false;

    /* --- Klick (nur das Fake-Feld) --- */
    dropArea.addEventListener("click", () => fileInput.click());

    /* --- Drag & Drop auf der gesamten Karte --- */
    container.addEventListener("dragover", (e) => {
        e.preventDefault();
        container.classList.add("vz-dragover");
    });

    container.addEventListener("dragleave", (e) => {
        // nur entfernen, wenn wir wirklich raus sind
        if (!container.contains(e.relatedTarget)) {
            container.classList.remove("vz-dragover");
        }
    });

    container.addEventListener("drop", (e) => {
        e.preventDefault();
        container.classList.remove("vz-dragover");
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    fileInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files[0]) {
            handleFile(e.target.files[0]);
        }
    });

    function handleFile(file) {
        if (!file || file.type !== "application/pdf") {
            alert("Bitte nur PDF-Dateien hochladen.");
            return;
        }

        selectedFile = file;
        resultBody   = null;
        overlayOpened = false;

        fileNameEl.textContent = file.name;

        // Fake-Feld bleibt oben, aber unsere Logik startet:
        fileRow.style.display   = "flex";
        resultBox.style.display = "none";
        waitBox.style.display   = "none";

        if (legalBox)   legalBox.style.display  = "block";
        if (checkArea)  checkArea.style.display = "block";
        if (acceptCheck) acceptCheck.checked    = false;
        if (checkBtn)   checkBtn.disabled       = true;
    }

    fileRemove.addEventListener("click", () => {
        selectedFile = null;
        resultBody   = null;
        overlayOpened = false;

        fileRow.style.display   = "none";
        resultBox.style.display = "none";
        waitBox.style.display   = "none";

        if (legalBox)   legalBox.style.display  = "none";
        if (checkArea)  checkArea.style.display = "none";
        if (acceptCheck) acceptCheck.checked    = false;
        if (checkBtn)   checkBtn.disabled       = true;
    });

    if (acceptCheck) {
        acceptCheck.addEventListener("change", () => {
            if (!checkBtn) return;
            checkBtn.disabled = !(selectedFile && acceptCheck.checked);
        });
    }

    /* --- Pr√ºfen --- */
    if (checkBtn) {
        checkBtn.addEventListener("click", async () => {
            if (!selectedFile) return;

            // alles ausblenden au√üer Titel + Fake-Feld, nur Ladezustand anzeigen
            if (legalBox)   legalBox.style.display  = "none";
            if (checkArea)  checkArea.style.display = "none";
            fileRow.style.display   = "none";
            resultBox.style.display = "none";
            waitBox.style.display   = "block";

            try {
                const base64 = await fileToBase64(selectedFile);
                const payload = {
                    fileName: selectedFile.name,
                    fileContent: base64
                };

                const res = await fetch(
                    "https://default91b0e232846941aab7d1176f14ecb7.8c.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/740a58efef1a4952af4c7e05e0ddea74/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=gsPq8vYpfRdArQN6KQdM1FDGilRliBu9VFrMcAYi3iQ",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    }
                );

                let data;
                try {
                    data = await res.json();
                } catch (err) {
                    console.error("Antwort kein JSON", err);
                    showError("Die Antwort konnte nicht gelesen werden.");
                    return;
                }

                let body = data;
                if (data && typeof data === "object" && "body" in data) {
                    if (typeof data.body === "string") {
                        try {
                            body = JSON.parse(data.body);
                        } catch {
                            body = {};
                        }
                    } else {
                        body = data.body || {};
                    }
                }

                resultBody = body;
                renderResult(body);

            } catch (err) {
                console.error("Fehler beim Pr√ºfen", err);
                showError("Beim Pr√ºfen ist ein Fehler aufgetreten.");
            }
        });
    }

    function fileToBase64(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => {
                const res = reader.result;
                const base64 = typeof res === "string" ? res.split(",")[1] : "";
                resolve(base64);
            };
            reader.readAsDataURL(file);
        });
    }

    function labelForKey(key) {
        if (key === "windpark_nummer") return "Windpark ID";
        if (key === "windpark_name")   return "Windpark";
        return key.replace(/_/g, " ");
    }

    function showError(msg) {
        waitBox.style.display   = "none";
        fileRow.style.display   = selectedFile ? "flex" : "none";
        resultBox.style.display = "block";
        resultBox.innerHTML     = `<p class="vz-error">${msg}</p>`;
    }

    function renderResult(body) {
        waitBox.style.display = "none";

        if (!body || body.ist_router_einbau_rechnung === false) {
            showError("Rechnung nicht erkannt.");
            return;
        }

        fileRow.style.display = "flex";

        let html = "<table>";
        for (const key in body) {
            if (!Object.prototype.hasOwnProperty.call(body, key)) continue;
            if (key === "ist_router_einbau_rechnung") continue;

            const val = body[key];
            const editable = val === null || val === "" || typeof val === "undefined";

            const valueHtml = editable
                ? `<input type="text" class="vz-edit" data-field="${key}" placeholder="Bitte erg√§nzen">`
                : String(val);

            html += `
                <tr>
                    <td><strong>${labelForKey(key)}:</strong></td>
                    <td>${valueHtml}</td>
                </tr>`;
        }
        html += "</table>";

        resultBox.innerHTML    = html;
        resultBox.style.display = "block";

        const edits = resultBox.querySelectorAll("input.vz-edit");
        edits.forEach(inp => {
            const field = inp.getAttribute("data-field");
            inp.addEventListener("input", () => {
                if (!resultBody) return;
                resultBody[field] = inp.value;
                maybeOpenOverlay();
            });
        });

        // Falls schon alles vollst√§ndig ist
        maybeOpenOverlay();
    }

    function allFieldsFilled() {
        if (!resultBody) return false;
        for (const key in resultBody) {
            if (!Object.prototype.hasOwnProperty.call(resultBody, key)) continue;
            if (key === "ist_router_einbau_rechnung") continue;
            const val = resultBody[key];
            if (val === null || val === "" || typeof val === "undefined") {
                return false;
            }
        }
        return true;
    }

    function maybeOpenOverlay() {
        if (overlayOpened) return;
        if (!allFieldsFilled()) return;

        overlayOpened = true;
        if (typeof openOverlay === "function") {
            openOverlay();
        }
        if (typeof loadSection === "function") {
            loadSection("vertragsvorlage", "vertragsvorlage.html");
        }
    }
})();
</script>
