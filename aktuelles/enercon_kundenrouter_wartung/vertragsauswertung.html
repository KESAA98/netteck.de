<div class="vz-wrapper">

    <!-- Titel -->
    <h2 class="vz-title">
        Anfrage<br>
        Wartungs- &amp; Servicevertrag
    </h2>

    <!-- Einleitung -->
    <p class="vz-subtext">
        Hier kÃ¶nnen Sie Ihren Wartungs- &amp; Servicevertrag anfragen.
        Laden Sie einfach die Schluss- oder Abschlagsrechnung fÃ¼r den Routereinbau
        von Kevin Strakerjahn Networks &amp; Automation hoch und erhalten Sie in
        wenigen Augenblicken Ihren Mustervertrag.
    </p>

    <!-- Upload-Bereich -->
    <div class="vz-section">
        <div id="vz-drop-area" class="vz-drop-area">
            <div class="vz-drop-content">
                <div class="vz-drop-icon">ðŸ“„</div>
                <div class="vz-drop-title">Rechnung hochladen</div>
                <div class="vz-drop-text">Datei hierher ziehen oder klicken</div>
                <div class="vz-drop-hint">Es wird genau eine PDF-Datei benÃ¶tigt.</div>
            </div>
            <input type="file" id="vz-file-input" accept="application/pdf" hidden>
        </div>

        <!-- Datei-Anzeige -->
        <div id="vz-file-box" class="vz-file-box" style="display:none;">
            <div class="vz-file-left">
                <span class="vz-file-icon">ðŸ“„</span>
                <span id="vz-file-name" class="vz-file-name"></span>
            </div>
            <button id="vz-file-remove" class="vz-file-remove" type="button">ðŸ—‘</button>
        </div>
    </div>

    <!-- DSGVO / AGB -->
    <div id="vz-legal" class="vz-section" style="display:none;">
        <label class="vz-check-label">
            <input type="checkbox" id="vz-accept">
            <span>Ich akzeptiere die
                <a href="/datenschutz" target="_blank">DatenschutzerklÃ¤rung</a> und
                <a href="/agb" target="_blank">AGBs</a>.
            </span>
        </label>
    </div>

    <!-- PrÃ¼fen -->
    <div id="vz-check-section" class="vz-section" style="display:none;">
        <button id="vz-check-btn" class="vz-btn" disabled>PrÃ¼fen</button>
    </div>

    <!-- Hinweis -->
    <div id="vz-wait" class="vz-section vz-wait" style="display:none;">
        Die PrÃ¼fung der Rechnung kann 10â€“30 Sekunden dauernâ€¦
    </div>

    <!-- Ergebnis -->
    <div id="vz-result" class="vz-section vz-result" style="display:none;"></div>

    <!-- Ansprechpartner -->
    <div id="vz-contact" class="vz-section vz-contact" style="display:none;">
        <label class="vz-check-label">
            <input type="checkbox" id="vz-self-contact">
            <span>Sind Sie Ansprechpartner <span id="vz-ansprech-name"></span>?</span>
        </label>

        <div id="vz-contact-extra" class="vz-contact-extra" style="display:none;">
            <input id="vz-vorname" type="text" placeholder="Vorname">
            <input id="vz-nachname" type="text" placeholder="Nachname">
            <input id="vz-firma" type="text" placeholder="Firma">
        </div>

        <input id="vz-email" type="email" placeholder="E-Mail">
    </div>

    <!-- Weiter -->
    <div id="vz-next-section" class="vz-section" style="display:none;">
        <button id="vz-next-btn" class="vz-btn" disabled>Preise anzeigen</button>
    </div>

</div>

<style>
    .vz-wrapper {
        padding: 20px;                 /* Innenabstand fÃ¼r alles */
        margin: 0 !important;          /* KEIN AuÃŸenabstand */
        font-size: 0.95rem;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }

    .vz-title {
        margin-bottom: 6px;
        font-size: 1.05rem;
        font-weight: 600;
    }

    .vz-subtext {
        margin-bottom: 12px;
        font-size: 0.9rem;
        line-height: 1.45;
    }

    .vz-section {
        margin-top: 14px;
    }

    /* Drag-Feld schÃ¶ner */
    .vz-drop-area {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        background: #f8fafc;
        padding: 22px;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
    }

    .vz-drop-area:hover {
        background: #f1f5f9;
    }

    .vz-drop-icon {
        font-size: 1.9rem;
        margin-bottom: 6px;
    }

    .vz-drop-title {
        font-weight: 600;
    }

    .vz-drop-text {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    /* Datei Box */
    .vz-file-box {
        padding: 10px;
        border-radius: 10px;
        background: #f1f5f9;
        border: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .vz-file-name {
        font-weight: 600;
        color: #374151;
    }

    .vz-file-remove {
        border: none;
        background: transparent;
        cursor: pointer;
        color: #c53030;
        font-size: 1.1rem;
    }

    /* Buttons */
    .vz-btn {
        padding: 8px 16px;
        border-radius: 999px;
        background: var(--primary);
        border: none;
        color: white;
        cursor: pointer;
    }

    .vz-btn:disabled {
        background: #bcd4ff;
        cursor: not-allowed;
    }

    /* Hinweis */
    .vz-wait {
        font-size: 0.85rem;
        color: #6b7280;
    }

    /* Tabelle kompakt */
    .vz-result {
        background: #f8fafc;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        font-size: 0.85rem;
    }

    .vz-result table {
        width: 100%;
        border-collapse: collapse;
    }

    .vz-result td {
        padding: 4px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    /* Kontakt */
    .vz-contact input {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        width: 100%;
    }
</style>

<script>
(function () {
    "use strict";

    const dropArea      = document.getElementById("vz-drop-area");
    const fileInput     = document.getElementById("vz-file-input");
    const fileBox       = document.getElementById("vz-file-box");
    const fileNameSpan  = document.getElementById("vz-file-name");
    const fileRemoveBtn = document.getElementById("vz-file-remove");

    const legalSection  = document.getElementById("vz-legal");
    const acceptCheck   = document.getElementById("vz-accept");

    const checkSection  = document.getElementById("vz-check-section");
    const checkBtn      = document.getElementById("vz-check-btn");

    const waitBox       = document.getElementById("vz-wait");
    const resultBox     = document.getElementById("vz-result");

    const contactBox    = document.getElementById("vz-contact");
    const selfContact   = document.getElementById("vz-self-contact");
    const contactExtra  = document.getElementById("vz-contact-extra");
    const ansNameSpan   = document.getElementById("vz-ansprech-name");

    const vornameInput  = document.getElementById("vz-vorname");
    const nachnameInput = document.getElementById("vz-nachname");
    const firmaInput    = document.getElementById("vz-firma");
    const emailInput    = document.getElementById("vz-email");

    const nextSection   = document.getElementById("vz-next-section");
    const nextBtn       = document.getElementById("vz-next-btn");

    if (!dropArea || !fileInput) {
        console.error("vertragsauswertung.html: Grundelemente nicht gefunden.");
        return;
    }

    let selectedFile = null;
    let resultBody   = null;

    /* ---------- Upload ---------- */

    dropArea.addEventListener("click", () => fileInput.click());

    dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.classList.add("vz-dragover");
    });

    dropArea.addEventListener("dragleave", () => {
        dropArea.classList.remove("vz-dragover");
    });

    dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.classList.remove("vz-dragover");
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    fileInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files[0]) {
            handleFile(e.target.files[0]);
        }
    });

    function handleFile(file) {
        if (!file || file.type !== "application/pdf") {
            alert("Bitte nur PDF-Dateien hochladen.");
            return;
        }

        selectedFile = file;
        fileNameSpan.textContent = file.name;

        dropArea.style.display  = "none";
        fileBox.style.display   = "flex";

        resultBox.style.display = "none";
        contactBox.style.display = "none";
        nextSection.style.display = "none";
        if (waitBox) waitBox.style.display = "none";

        if (legalSection)  legalSection.style.display = "block";
        if (checkSection)  checkSection.style.display = "block";
        if (acceptCheck)   acceptCheck.checked = false;
        if (checkBtn)      checkBtn.disabled = true;
    }

    fileRemoveBtn.addEventListener("click", () => {
        selectedFile = null;
        resultBody   = null;

        fileBox.style.display   = "none";
        dropArea.style.display  = "flex";
        resultBox.style.display = "none";
        contactBox.style.display = "none";
        nextSection.style.display = "none";
        if (waitBox) waitBox.style.display = "none";

        if (legalSection) legalSection.style.display = "none";
        if (checkSection) checkSection.style.display = "none";
        if (acceptCheck)  acceptCheck.checked = false;
        if (checkBtn)     checkBtn.disabled = true;
    });

    if (acceptCheck) {
        acceptCheck.addEventListener("change", () => {
            if (!checkBtn) return;
            checkBtn.disabled = !(selectedFile && acceptCheck.checked);
        });
    }

    /* ---------- PrÃ¼fen ---------- */

    if (checkBtn) {
        checkBtn.addEventListener("click", async () => {
            if (!selectedFile) return;

            const oldText = checkBtn.textContent;

            // Checkbox + Button ausblenden, Hinweis einblenden
            if (legalSection)  legalSection.style.display = "none";
            if (checkSection)  checkSection.style.display = "none";
            if (waitBox)       waitBox.style.display = "block";

            checkBtn.disabled = true;
            checkBtn.textContent = "Wird geprÃ¼ftâ€¦";

            try {
                const b64 = await fileToBase64(selectedFile);

                const payload = {
                    fileName: selectedFile.name,
                    fileContent: b64
                };

                const res = await fetch(
                    "https://default91b0e232846941aab7d1176f14ecb7.8c.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/740a58efef1a4952af4c7e05e0ddea74/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=gsPq8vYpfRdArQN6KQdM1FDGilRliBu9VFrMcAYi3iQ",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    }
                );

                let data;
                try {
                    data = await res.json();
                } catch (err) {
                    console.error("Antwort kein JSON", err);
                    showError("Die Antwort konnte nicht gelesen werden.");
                    return;
                }

                let body = data;
                if (data && typeof data === "object" && "body" in data) {
                    if (typeof data.body === "string") {
                        try {
                            body = JSON.parse(data.body);
                        } catch (err) {
                            console.error("body-String nicht parsebar", err);
                            body = {};
                        }
                    } else {
                        body = data.body || {};
                    }
                }

                resultBody = body;
                renderResult(body);

            } catch (err) {
                console.error("Fehler beim PrÃ¼fen", err);
                showError("Beim PrÃ¼fen ist ein Fehler aufgetreten.");
                // Bei Fehler darf man neu versuchen: Checkbox + Button wieder anzeigen
                if (legalSection)  legalSection.style.display = "block";
                if (checkSection)  checkSection.style.display = "block";
            } finally {
                if (waitBox) waitBox.style.display = "none";
                checkBtn.textContent = oldText;
                checkBtn.disabled = !(selectedFile && acceptCheck && acceptCheck.checked);
            }
        });
    }

    function fileToBase64(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => {
                const result = reader.result;
                const base64 = typeof result === "string" ? result.split(",")[1] : "";
                resolve(base64);
            };
            reader.readAsDataURL(file);
        });
    }

    function showError(msg) {
        resultBox.innerHTML = `<p style="color:#b91c1c;">${msg}</p>`;
        resultBox.style.display = "block";
        contactBox.style.display = "none";
        nextSection.style.display = "none";
        if (waitBox) waitBox.style.display = "none";
    }

    function labelForKey(key) {
        if (key === "windpark_nummer") return "Windpark ID";
        if (key === "windpark_name")   return "Windpark";
        return key.replace(/_/g, " ");
    }

    function renderResult(body) {
        if (!body || body.ist_router_einbau_rechnung === false) {
            showError("Rechnung nicht erkannt.");
            return;
        }

        let html = "<table>";
        for (const key in body) {
            if (!Object.prototype.hasOwnProperty.call(body, key)) continue;
            if (key === "ist_router_einbau_rechnung") continue;
            if (key === "Ansprechpartner") continue; // nicht in der Tabelle anzeigen

            const val = body[key];
            const editable = val === null || val === "" || typeof val === "undefined";

            const valueHtml = editable
                ? `<input type="text" class="vz-edit" data-field="${key}" placeholder="Bitte ergÃ¤nzen">`
                : String(val);

            html += `<tr>
                        <td><strong>${labelForKey(key)}:</strong></td>
                        <td>${valueHtml}</td>
                     </tr>`;
        }
        html += "</table>";

        resultBox.innerHTML = html;
        resultBox.style.display = "block";
        if (waitBox) waitBox.style.display = "none";

        // Editierbare Felder zurÃ¼ck in body schreiben
        const inputs = resultBox.querySelectorAll("input.vz-edit");
        inputs.forEach((inp) => {
            const field = inp.getAttribute("data-field");
            inp.addEventListener("input", () => {
                if (!resultBody) return;
                resultBody[field] = inp.value;
            });
        });

        ansNameSpan.textContent = body.Ansprechpartner || "";
        if (selfContact) {
            selfContact.checked = true; // vorab angehakt
        }
        if (contactExtra) {
            contactExtra.style.display = "none";
        }

        contactBox.style.display = "flex";
        nextSection.style.display = "block";

        updateNextState();
    }

    /* ---------- Kontakt / Weiter ---------- */

    if (selfContact) {
        selfContact.addEventListener("change", () => {
            contactExtra.style.display = selfContact.checked ? "none" : "flex";
            updateNextState();
        });
    }

    [vornameInput, nachnameInput, firmaInput, emailInput].forEach((inp) => {
        if (!inp) return;
        inp.addEventListener("input", updateNextState);
    });

    function updateNextState() {
        if (!nextBtn) return;

        let ok = emailInput && emailInput.value.trim().length > 4;

        if (!selfContact.checked) {
            ok = ok &&
                vornameInput.value.trim().length > 1 &&
                nachnameInput.value.trim().length > 1 &&
                firmaInput.value.trim().length > 1;
        }

        nextBtn.disabled = !ok;
    }

    if (nextBtn) {
        nextBtn.addEventListener("click", () => {
            if (typeof openOverlay === "function") {
                openOverlay();
            }
            if (typeof loadSection === "function") {
                loadSection("vertragsvorlage", "vertragsvorlage.html");
            }
        });
    }
})();
</script>
