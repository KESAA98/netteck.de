<div class="vz-wrapper" id="vz-wrapper">

    <!-- Titel -->
    <h2 class="vz-title">
        Anfrage<br>
        <span>Wartungs- &amp; Servicevertrag</span>
    </h2>

    <!-- Alles ist Drag&Drop solange keine Datei gewählt ist -->
    <div id="vz-drop-area" class="vz-drop-area" role="button" tabindex="0" aria-label="PDF hochladen">
        <div class="vz-drop-inner">
            <p class="vz-intro-line">
                Hier können Sie Ihren eigenen Wartungs- &amp; Servicevertrag anfragen.
            </p>

            <img src="/Logos/PDF_Icon.png" alt="PDF" class="vz-pdf-icon">

            <p class="vz-intro-text">
                Laden Sie einfach die Rechnung als PDF für den von
                <strong>Kevin Strakerjahn Networks &amp; Automation</strong>
                eingebauten Router hier hoch.
            </p>

            <div class="vz-mini">
                <p>Es kann genau <strong>eine</strong> PDF-Datei hochgeladen werden.</p>
                <p>Datei einfach hier hineinziehen oder klicken.</p>
            </div>
        </div>

        <input type="file" id="vz-file-input" accept="application/pdf" hidden>
    </div>

    <!-- Datei-Zeile -->
    <div id="vz-file-row" class="vz-file-row" style="display:none;">
        <div class="vz-file-left">
            <img src="/Logos/PDF_Icon.png" alt="PDF" class="vz-file-pdf">
            <div class="vz-file-meta">
                <div id="vz-file-name" class="vz-file-name"></div>
                <div class="vz-file-sub">PDF ausgewählt</div>
            </div>
        </div>

        <button id="vz-file-remove" class="vz-icon-btn" type="button" aria-label="Datei entfernen" title="Datei entfernen">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M9 3h6l1 2h5v2H3V5h5l1-2Zm1 7h2v9h-2v-9Zm4 0h2v9h-2v-9ZM6 10h2v9H6v-9Z"/>
            </svg>
        </button>
    </div>

    <!-- Datenschutz -->
    <div id="vz-legal" class="vz-legal" style="display:none;">
        <label class="vz-check">
            <input type="checkbox" id="vz-accept">
            <span>
                Ich akzeptiere die
                <a href="/datenschutz" target="_blank">Datenschutzerklärung</a>
                und die
                <a href="/agb" target="_blank">AGBs</a>.
            </span>
        </label>
    </div>

    <!-- Button -->
    <div id="vz-check-area" class="vz-check-area" style="display:none;">
        <button id="vz-check-btn" class="vz-btn" type="button" disabled>Rechnung prüfen</button>
    </div>

    <!-- Loading -->
    <div id="vz-wait" class="vz-wait" style="display:none;">
        <div class="vz-spinner"></div>
        <p>Die Rechnung wird geprüft. Dies kann 10–30 Sekunden dauern…</p>
    </div>

    <!-- Ergebnis -->
    <div id="vz-result" class="vz-result" style="display:none;"></div>

</div>

<style>
    .service-card#vertragsauswertung { padding: 0; }

    /* Außenfläche */
    .vz-wrapper{
        margin:0;
        padding:16px;
        box-sizing:border-box;
        height:100%;
        background:#f3f4f6;
        border-radius:0;
        display:flex;
        flex-direction:column;
        gap:10px;
        transition: background-color .18s ease;
    }
    .vz-wrapper.vz-dragover{ background:#e5f0ff; }

    .vz-title{
        text-align:center;
        margin:0;
        font-size:1.15rem;
        font-weight:800;
        line-height:1.25;
        color:var(--text-main);
    }
    .vz-title span{ font-weight:800; }

    /* Drop-Fläche füllt restliche Höhe */
    .vz-drop-area{
        flex:1;
        display:flex;
        align-items:center;
        justify-content:center;
        text-align:center;

        background:#e5e7eb;
        border:2px dashed #cbd5e1;
        border-radius:16px;

        padding:18px 14px;
        cursor:pointer;
        transition: border-color .18s ease, background-color .18s ease;
        user-select:none;
    }
    .vz-wrapper.vz-dragover .vz-drop-area{
        background:#dbeafe;
        border-color:var(--primary);
    }

    .vz-drop-inner{
        max-width:280px;
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:10px;
    }

    .vz-intro-line{
        margin:0;
        font-size:1rem;
        font-weight:700;
        color:var(--text-main);
    }

    .vz-pdf-icon{
        width:56px;
        height:auto;
        filter: drop-shadow(0 2px 6px rgba(0,0,0,0.08));
    }

    .vz-intro-text{
        margin:0;
        font-size:0.92rem;
        line-height:1.45;
        color:var(--text-main);
    }

    .vz-mini{
        margin-top:2px;
        padding:10px 12px;
        background:rgba(255,255,255,0.55);
        border:1px solid rgba(203,213,225,0.65);
        border-radius:12px;
        font-size:0.82rem;
        color:var(--text-muted);
        line-height:1.35;
    }
    .vz-mini p{ margin:0; }
    .vz-mini p + p{ margin-top:6px; }

    /* Datei-Zeile */
    .vz-file-row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;

        padding:10px 12px;
        background:#ffffff;
        border:1px solid #e5e7eb;
        border-radius:12px;
        box-shadow: 0 1px 8px rgba(15,23,42,0.05);
    }

    .vz-file-left{
        display:flex;
        align-items:center;
        gap:10px;
        min-width:0;
    }
    .vz-file-pdf{ width:28px; height:auto; }

    .vz-file-meta{ min-width:0; }
    .vz-file-name{
        font-weight:800;
        color:#111827;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        max-width:240px;
        font-size:0.92rem;
    }
    .vz-file-sub{
        font-size:0.78rem;
        color:var(--text-muted);
        margin-top:2px;
    }

    .vz-icon-btn{
        width:38px;
        height:38px;
        border-radius:10px;
        border:1px solid #e5e7eb;
        background:#f8fafc;
        display:grid;
        place-items:center;
        cursor:pointer;
        transition: background-color .15s ease, border-color .15s ease;
    }
    .vz-icon-btn:hover{
        background:#fee2e2;
        border-color:#fecaca;
    }
    .vz-icon-btn svg{
        width:18px;
        height:18px;
        fill:#b91c1c;
    }

    /* Checkbox */
    .vz-legal{ margin-top:2px; }
    .vz-check{
        display:flex;
        align-items:flex-start;
        gap:8px;
        font-size:0.88rem;
        color:#111827;
        line-height:1.3;
    }
    .vz-check input{ margin-top:2px; }
    .vz-check a{ text-decoration:underline; }

    /* Button */
    .vz-check-area{
        display:flex;
        justify-content:flex-end;
    }
    .vz-btn{
        padding:9px 16px;
        border-radius:999px;
        border:none;
        background:var(--primary);
        color:white;
        font-weight:700;
        font-size:0.92rem;
        cursor:pointer;
        box-shadow: 0 6px 18px rgba(11,116,255,0.18);
    }
    .vz-btn:disabled{
        background:#bcd4ff;
        box-shadow:none;
        cursor:not-allowed;
    }

    /* Loading */
    .vz-wait{
        text-align:center;
        font-size:0.88rem;
        color:#4b5563;
        margin-top:8px;
    }
    .vz-spinner{
        width:28px;
        height:28px;
        border-radius:999px;
        border:3px solid #e5e7eb;
        border-top-color:var(--primary);
        margin:0 auto 8px;
        animation:vzSpin .8s linear infinite;
    }
    @keyframes vzSpin{ to{ transform:rotate(360deg); } }

    /* Result */
    .vz-result{
        margin-top:6px;
        padding:10px 10px 8px;
        border-radius:12px;
        background:#ffffff;
        border:1px solid #e5e7eb;
        box-shadow: 0 1px 8px rgba(15,23,42,0.05);
        font-size:0.86rem;
    }
    .vz-result table{ width:100%; border-collapse:collapse; }
    .vz-result td{ padding:4px 2px; border-bottom:1px solid #eef2f7; vertical-align:top; }
    .vz-result tr:last-child td{ border-bottom:none; }

    .vz-result input.vz-edit{
        width:100%;
        padding:6px 8px;
        border-radius:10px;
        border:1px solid #cbd5e1;
        font-size:0.86rem;
        background:#f8fafc;
        box-sizing:border-box;
    }
    .vz-error{ color:#b91c1c; font-weight:800; }
</style>

<script>
(function () {
    "use strict";

    const wrapper   = document.getElementById("vz-wrapper");
    const dropArea  = document.getElementById("vz-drop-area");
    const fileInput = document.getElementById("vz-file-input");

    const fileRow   = document.getElementById("vz-file-row");
    const fileName  = document.getElementById("vz-file-name");
    const removeBtn = document.getElementById("vz-file-remove");

    const legalBox  = document.getElementById("vz-legal");
    const checkArea = document.getElementById("vz-check-area");
    const checkBtn  = document.getElementById("vz-check-btn");
    const acceptChk = document.getElementById("vz-accept");

    const waitBox   = document.getElementById("vz-wait");
    const resultBox = document.getElementById("vz-result");

    let selectedFile = null;
    let parsedData   = null;
    let selectionOpened = false;

    // Drag highlight (nur wenn noch keine Datei)
    wrapper.addEventListener("dragover", (e) => {
        if (selectedFile) return;
        e.preventDefault();
        wrapper.classList.add("vz-dragover");
    });

    wrapper.addEventListener("dragleave", (e) => {
        if (selectedFile) return;
        if (!wrapper.contains(e.relatedTarget)) wrapper.classList.remove("vz-dragover");
    });

    wrapper.addEventListener("drop", (e) => {
        if (selectedFile) return;
        e.preventDefault();
        wrapper.classList.remove("vz-dragover");
        if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    // Klick überall öffnet Dateidialog (nur wenn noch keine Datei)
    wrapper.addEventListener("click", () => {
        if (!selectedFile) fileInput.click();
    });

    // Tastatur für DropArea
    dropArea.addEventListener("keydown", (e) => {
        if (selectedFile) return;
        if (e.key === "Enter" || e.key === " ") fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
        if (!file || file.type !== "application/pdf") {
            alert("Bitte nur PDF-Dateien hochladen.");
            return;
        }

        selectedFile = file;
        parsedData = null;
        selectionOpened = false;

        fileName.textContent = file.name;

        // Drop verschwindet, Rest erscheint
        dropArea.style.display  = "none";
        fileRow.style.display   = "flex";
        legalBox.style.display  = "block";
        checkArea.style.display = "flex";

        waitBox.style.display   = "none";
        resultBox.style.display = "none";

        acceptChk.checked = false;
        checkBtn.disabled = true;

        wrapper.classList.remove("vz-dragover");
    }

    removeBtn.addEventListener("click", (e) => {
        e.stopPropagation();

        selectedFile = null;
        parsedData = null;
        selectionOpened = false;

        dropArea.style.display  = "flex";
        fileRow.style.display   = "none";
        legalBox.style.display  = "none";
        checkArea.style.display = "none";
        waitBox.style.display   = "none";
        resultBox.style.display = "none";

        acceptChk.checked = false;
        checkBtn.disabled = true;
    });

    acceptChk.addEventListener("change", () => {
        checkBtn.disabled = !(acceptChk.checked && selectedFile);
    });

    checkBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        if (!selectedFile) return;

        // Nur Titel + Loader sichtbar
        fileRow.style.display   = "none";
        legalBox.style.display  = "none";
        checkArea.style.display = "none";
        resultBox.style.display = "none";
        waitBox.style.display   = "block";

        const base64 = await toBase64(selectedFile);

        const payload = { fileName: selectedFile.name, fileContent: base64 };

        let json;
        try {
            const res = await fetch(
                "https://default91b0e232846941aab7d1176f14ecb7.8c.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/740a58efef1a4952af4c7e05e0ddea74/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=gsPq8vYpfRdArQN6KQdM1FDGilRliBu9VFrMcAYi3iQ",
                { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }
            );
            json = await res.json();
        } catch {
            showError("Fehler bei der Analyse.");
            return;
        }

        let body = json;
        if (json && typeof json === "object" && "body" in json) {
            if (typeof json.body === "string") {
                try { body = JSON.parse(json.body); } catch { body = {}; }
            } else {
                body = json.body || {};
            }
        }

        parsedData = body;

        waitBox.style.display = "none";
        fileRow.style.display = "flex";

        if (!body || body.ist_router_einbau_rechnung === false) {
            showError("Rechnung nicht erkannt.");
            return;
        }

        renderTable(body);
        tryOpenSelectionIfComplete();
    });

    function toBase64(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(String(reader.result).split(",")[1] || "");
            reader.readAsDataURL(file);
        });
    }

    function showError(msg) {
        resultBox.innerHTML = `<p class="vz-error">${msg}</p>`;
        resultBox.style.display = "block";
    }

    function labelForKey(key) {
        if (key === "windpark_nummer") return "Windpark ID";
        if (key === "windpark_name") return "Windpark";
        return key.replace(/_/g, " ");
    }

    function renderTable(data) {
        let html = "<table>";

        for (const key in data) {
            if (!Object.prototype.hasOwnProperty.call(data, key)) continue;
            if (key === "ist_router_einbau_rechnung") continue;

            const label = labelForKey(key);
            const val = data[key];
            const editable = val === null || val === "";

            html += `
                <tr>
                    <td><strong>${label}:</strong></td>
                    <td>${
                        editable
                            ? `<input type="text" class="vz-edit" data-key="${key}" placeholder="Bitte ergänzen">`
                            : String(val)
                    }</td>
                </tr>
            `;
        }

        html += "</table>";
        resultBox.innerHTML = html;
        resultBox.style.display = "block";

        resultBox.querySelectorAll(".vz-edit").forEach(inp => {
            const k = inp.getAttribute("data-key");
            inp.addEventListener("input", () => {
                if (!parsedData) return;
                parsedData[k] = inp.value;
                tryOpenSelectionIfComplete();
            });
        });
    }

    function tryOpenSelectionIfComplete() {
        if (selectionOpened || !parsedData) return;

        for (const key in parsedData) {
            if (!Object.prototype.hasOwnProperty.call(parsedData, key)) continue;
            if (key === "ist_router_einbau_rechnung") continue;
            const v = parsedData[key];
            if (v === null || v === "") return;
        }

        selectionOpened = true;

        if (typeof openSelection === "function") openSelection();

        if (typeof loadSection === "function") {
            loadSection("selection", "vertragsauswahl.html");
        }
    }

})();
</script>
