<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Step 1 – Rechnung prüfen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../../../../Logos/logo.png" />

  <style>
    :root {
      --primary: #0b74ff;
      --primary-soft: rgba(11, 116, 255, 0.10);
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --border: #e1e4ec;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --radius-lg: 14px;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      line-height: 1.6;
      overflow: hidden; /* Step soll fullscreen wirken */
    }

    /* Fullscreen layout (gleicher Abstand oben/unten, wie gewünscht) */
    .viewport {
      height: 100vh;
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem; /* Seitenabstand wie Index */
    }

    .card {
      width: min(1100px, 100%);
      height: 100%;
      max-height: calc(100vh - 4rem); /* oben/unten jeweils 2rem */
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      border: 1px solid var(--border);
      padding: 1.75rem 1.9rem 2.1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    h1 {
      margin: 0;
      font-size: 1.45rem;
      text-align: center;
      letter-spacing: 0.2px;
    }

    .sub {
      margin: 0;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .dropzone {
      position: relative;
      flex: 1;
      border: 2px dashed var(--border);
      border-radius: 16px;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.4rem;
      transition: border-color .15s ease, background .15s ease, box-shadow .15s ease, transform .15s ease;
      cursor: pointer;
      user-select: none;
      overflow: hidden;
    }
    .dropzone:hover {
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 5px var(--primary-soft);
      transform: translateY(-1px);
    }
    .dropzone.dragover {
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 6px var(--primary-soft);
    }

    .dz-inner {
      text-align: center;
      max-width: 720px;
    }

    .pdf-icon {
      width: 92px;
      height: auto;
      display: block;
      margin: 0 auto 0.9rem;
      filter: drop-shadow(0 6px 14px rgba(15, 23, 42, 0.10));
    }

    .dz-title {
      margin: 0 0 0.35rem;
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--text-main);
    }
    .dz-text {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.95rem;
      line-height: 1.45;
    }

    .fineprint {
      margin: 0;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    input[type="file"] { display: none; }

    /* Loading overlay */
    .loading {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 0.9rem;
      padding: 1.4rem;
    }
    .loading.show { display: flex; }

    .spinner {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 4px solid rgba(11,116,255,0.18);
      border-top-color: rgba(11,116,255,0.95);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading .msg {
      text-align: center;
      color: var(--text-main);
      font-weight: 650;
    }
    .loading .hint {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.92rem;
      max-width: 520px;
    }

    .error {
      display: none;
      margin-top: 0.2rem;
      text-align: center;
      color: #b42318;
      background: #fff5f5;
      border: 1px solid #ffd0d0;
      padding: 0.6rem 0.8rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .error.show { display: block; }
  </style>
</head>

<body>
  <div class="viewport">
    <div class="card" role="main" aria-label="Rechnung prüfen">
      <h1>Rechnung prüfen</h1>
      <p class="sub">Bitte laden Sie Ihre PDF-Rechnung oder Abschlagsrechnung hoch.</p>

      <div class="dropzone" id="dropzone" tabindex="0" role="button" aria-label="PDF hochladen">
        <div class="dz-inner" id="dzInner">
          <img class="pdf-icon" src="../../../../Logos/PDF_Icon.png" alt="PDF" />
          <p class="dz-title">Rechnung / Abschlagsrechnung hochladen</p>
          <p class="dz-text">
            Laden Sie Ihre Rechnung oder Abschlagsrechnung des Routereinbaus durch
            Kevin Strakerjahn Networks &amp; Automation hoch.<br>
            Ziehen Sie einfach die PDF in das Feld – oder klicken Sie in das Feld, um die Datei auszuwählen.
          </p>
        </div>

        <div class="loading" id="loading">
          <div class="spinner" aria-hidden="true"></div>
          <div class="msg">Rechnung wird analysiert…</div>
          <div class="hint">Je nach Auslastung und Verbindung kann das 10–40 Sekunden dauern. Bitte Seite geöffnet lassen.</div>
        </div>
      </div>

      <div class="error" id="errorBox">
        Das Analysieren ist fehlgeschlagen. Versuchen Sie es erneut oder schreiben Sie direkt an <span style="white-space:nowrap;">info@netteck.de</span>.
      </div>

      <p class="fineprint">Dateiformat: <b>PDF</b> (nur eine Datei)</p>

      <input id="fileInput" type="file" accept="application/pdf,.pdf" />
    </div>
  </div>

  <script>
    const FLOW_URL = "https://default91b0e232846941aab7d1176f14ecb7.8c.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/740a58efef1a4952af4c7e05e0ddea74/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=gsPq8vYpfRdArQN6KQdM1FDGilRliBu9VFrMcAYi3iQ";

    const dz = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const loading = document.getElementById("loading");
    const errorBox = document.getElementById("errorBox");

    function showError(show){
      errorBox.classList.toggle("show", !!show);
    }

    function setLoading(on){
      loading.classList.toggle("show", !!on);
      dz.style.pointerEvents = on ? "none" : "auto";
    }

    function resetUI(){
      setLoading(false);
      showError(false);
      dz.classList.remove("dragover");
      fileInput.value = "";
    }

    function isPdf(file){
      if (!file) return false;
      const nameOk = (file.name || "").toLowerCase().endsWith(".pdf");
      const typeOk = (file.type || "").toLowerCase() === "application/pdf";
      return nameOk || typeOk;
    }

    function fileToBase64(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error("read_error"));
        reader.onload = () => {
          const result = reader.result; // data:application/pdf;base64,....
          if (typeof result !== "string") return reject(new Error("read_error"));
          const base64 = result.split(",")[1] || "";
          resolve(base64);
        };
        reader.readAsDataURL(file);
      });
    }

    async function sendToFlow(file){
      showError(false);
      setLoading(true);

      try{
        if (!isPdf(file)){
          setLoading(false);
          showError(true);
          return;
        }

        const base64 = await fileToBase64(file);

        const payload = {
          fileName: file.name,
          fileContent: base64
        };

        const resp = await fetch(FLOW_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await resp.json().catch(() => null);
        if (!resp.ok || !data){
          throw new Error("bad_response");
        }

        // Power Automate liefert oft { statusCode, headers, body }
        let body = data.body ?? data;
        if (typeof body === "string") {
          try { body = JSON.parse(body); } catch(e) {}
        }

        // Erwartet: body.ist_router_einbau_rechnung === true
        const ok = !!(body && body.ist_router_einbau_rechnung === true);

        if (ok){
          // Für Step 2 speichern
          sessionStorage.setItem("rechnungAnalyse", JSON.stringify(body));

          setLoading(false);

          // Nächster Schritt (im parent index)
          if (window.parent && typeof window.parent.nextStep === "function"){
            window.parent.nextStep();
          }
          return;
        }

        // nicht ok
        throw new Error("analysis_failed");

      }catch(e){
        console.error(e);
        setLoading(false);
        showError(true);
        fileInput.value = "";
      }
    }

    // Click -> file picker
    dz.addEventListener("click", () => fileInput.click());
    dz.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " "){
        e.preventDefault();
        fileInput.click();
      }
    });

    // file selected
    fileInput.addEventListener("change", () => {
      const file = fileInput.files && fileInput.files[0];
      if (file) sendToFlow(file);
    });

    // Drag & Drop
    ["dragenter","dragover"].forEach(ev => {
      dz.addEventListener(ev, (e) => {
        e.preventDefault();
        dz.classList.add("dragover");
      });
    });
    ["dragleave","drop"].forEach(ev => {
      dz.addEventListener(ev, (e) => {
        e.preventDefault();
        dz.classList.remove("dragover");
      });
    });

    dz.addEventListener("drop", (e) => {
      const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (file) sendToFlow(file);
    });

    // Initial state
    resetUI();
  </script>
</body>
</html>
