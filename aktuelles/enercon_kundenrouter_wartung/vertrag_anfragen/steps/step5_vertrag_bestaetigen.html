<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Step 5 – Vertrag bestätigen (Vorschau)</title>
  <link rel="icon" type="image/png" href="/netteck.de/Logos/logo.png">

  <!-- pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <!-- pdf.js (Canvas-Render, ohne Toolbar) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    :root{
      --primary:#0b74ff;
      --primary2:#7a5cff;
      --bg:#f5f7fb;
      --card:#fff;
      --border:#e1e4ec;
      --text:#1f2933;
      --muted:#6b7280;
      --danger:#b42318;
      --ok:#067647;
      --shadow: 0 18px 60px rgba(16,24,40,.10);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(11,116,255,.14), transparent 60%),
        linear-gradient(#f7f9ff, var(--bg));
    }
    .viewport{ min-height:100vh; display:flex; justify-content:center; padding:28px 14px 40px; }
    .card{
      width:min(1100px,100%);
      background:var(--card);
      border:1px solid rgba(225,228,236,.9);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
    }
    h1{ margin:4px 0 4px; font-size:1.55rem; letter-spacing:-.02em; }
    .sub{ margin:0 0 14px; color:var(--muted); font-weight:600; line-height:1.4; }

    .notice{
      border:1px solid rgba(11,116,255,.18);
      background: rgba(11,116,255,.06);
      padding:10px 12px;
      border-radius: 14px;
      color:#0b3a88;
      font-weight:700;
      margin-bottom: 14px;
    }

    .pdfWrap{
      border:1px solid rgba(225,228,236,.9);
      border-radius: 16px;
      overflow:hidden;
      background:#fbfcff;
    }
    .pdfHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(225,228,236,.8);
      background: linear-gradient(180deg, rgba(11,116,255,.08), rgba(11,116,255,.02));
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .pdfTitle{ font-weight:950; }
    .pdfHint{ color:var(--muted); font-weight:650; font-size:.92rem; }
    .pdfPages{ padding:14px 14px 2px; }
    .pageCanvas{
      width:100%;
      display:block;
      border-radius: 12px;
      background:#fff;
      box-shadow: 0 10px 25px rgba(16,24,40,.10);
      border: 1px solid rgba(225,228,236,.9);
      margin:0 0 14px;
    }

    .actions{
      margin-top:16px;
      border-top:1px solid rgba(225,228,236,.9);
      padding-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){ .actions{ grid-template-columns: 1fr; } }

    .box{
      border:1px solid rgba(225,228,236,.9);
      border-radius: 16px;
      padding:12px;
      background:#fff;
    }
    .boxTitle{ font-weight:950; margin:0 0 8px; }
    textarea{
      width:100%;
      min-height:120px;
      resize: vertical;
      border:1px solid rgba(225,228,236,1);
      border-radius: 12px;
      padding:10px 10px;
      font: inherit;
      outline:none;
    }
    textarea:focus{
      border-color: rgba(11,116,255,.55);
      box-shadow: 0 0 0 6px rgba(11,116,255,.10);
    }

    .chk{ display:flex; gap:10px; align-items:flex-start; user-select:none; margin-top:12px; }
    .chk input{ margin-top:2px; transform:scale(1.1); accent-color: var(--primary); }
    .muted{ color:var(--muted); font-weight:650; font-size:.95rem; line-height:1.35; }

    .kv{
      border:1px solid rgba(225,228,236,.9);
      background:#fbfcff;
      border-radius: 14px;
      padding:10px 12px;
      line-height:1.25;
      margin-top:12px;
    }
    .kv b{ display:block; font-size:.92rem; }
    .kv span{ color:var(--muted); font-weight:750; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      border:none;
      border-radius:999px;
      padding:12px 16px;
      font-weight:950;
      cursor:pointer;
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btnPrimary{ color:#fff; background: linear-gradient(135deg, var(--primary), var(--primary2)); }
    .btnGhost{ background:#fff; color:var(--text); border:1px solid var(--border); text-decoration:none; }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); box-shadow: 0 0 0 5px rgba(11,116,255,.10); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; filter:none; box-shadow:none; }

    .error{
      display:none;
      border:1px solid #ffd0d0;
      background:#fff5f5;
      color:var(--danger);
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      text-align:center;
      margin-top:12px;
    }
    .error.show{ display:block; }
    .ok{
      display:none;
      border:1px solid rgba(6,118,71,.25);
      background: rgba(6,118,71,.08);
      color:var(--ok);
      border-radius:14px;
      padding:10px 12px;
      font-weight:950;
      text-align:center;
      margin-top:12px;
    }
    .ok.show{ display:block; }
  </style>
</head>

<body>
  <div class="viewport">
    <div class="card">
      <h1>Vertrag bestätigen</h1>
      <p class="sub">Die Vorschau wird automatisch erzeugt. Bitte einmal komplett durchscrollen – unten finden Sie die Anfrage-Aktionen.</p>

      <div class="notice" id="topNotice">PDF wird erstellt…</div>

      <div class="pdfWrap">
        <div class="pdfHead">
          <div>
            <div class="pdfTitle">PDF Vorschau</div>
            <div class="pdfHint" id="pdfHint">Bitte komplett durchscrollen</div>
          </div>
          <div class="pdfHint" id="contractNoHint">Vertragsnummer: –</div>
        </div>
        <div class="pdfPages" id="pdfPages"></div>
      </div>

      <div class="actions">
        <div class="box">
          <div class="boxTitle">Anmerkungen zu Ihrer Vertragsvorlage</div>
          <textarea id="notes" placeholder="Optional: z. B. abweichender Windparkname, besondere Anforderungen, Ansprechpartnerwechsel …"></textarea>

          <div class="chk">
            <input type="checkbox" id="sendCopy" checked />
            <div>
              <div style="font-weight:950;">Möchten Sie das Muster als Kopie per E-Mail erhalten?</div>
              <div class="muted">Wird an folgende Adresse gesendet: <span id="mailTo">–</span></div>
            </div>
          </div>

          <div class="kv">
            <b>Hinweis</b>
            <span>
              Nach dem Absenden erhalten wir Ihre Vertragsvorlage und prüfen diese. Wenn alles korrekt ist,
              erhalten Sie anschließend die Vertragsvorlage zur Unterschrift oder zur schriftlich eindeutig bestätigten Annahme.
              Bis zum Zeitpunkt der Bestätigung ist die Vorlage für beide Parteien unverbindlich.
            </span>
          </div>

          <div class="btnRow">
            <button class="btn btnPrimary" id="btnSend" type="button">Vertrag anfragen</button>
            <button class="btn btnGhost" id="btnBack" type="button">Zurück</button>
          </div>

          <div class="error" id="errorBox">Senden fehlgeschlagen. Bitte versuchen Sie es erneut.</div>
          <div class="ok" id="okBox">
            Ihre Anfrage wurde übermittelt.
            <div class="btnRow" style="justify-content:center; margin-top:10px;">
              <a class="btn btnGhost" href="/netteck.de/">Zur Startseite</a>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">Zusammenfassung</div>
          <div id="summaryGrid"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ----------------------------
  // PATHS / SETTINGS
  // ----------------------------
  const ANALYSE_KEY = "rechnungAnalyse";
  const PERSON_KEY  = "personConfirm";
  const PAKET_KEY   = "paketWahl";

  const WARTUNG_TXT_URL = "/netteck.de/aktuelles/enercon_kundenrouter_wartung/information/warungsvertrag.txt";

  // ✅ AGB-Laden wie deine aktuelle AGB-Index: GitHub API listet, danach lokal /AGB/AGBs/<file>
  const GITHUB_CONTENT_API = "https://api.github.com/repos/KESAA98/netteck.de/contents/AGB/AGBs";
  const AGB_LOCAL_DIR = "/netteck.de/AGB/AGBs/";

  // ✅ echtes Logo als Bild (nicht "KS" Text)
  const LOGO_IMG_URL = "/netteck.de/Logos/logo_name.jpeg"; // falls du ein anderes willst: hier ändern

  // Netlify Function (später)
  const NETLIFY_FN_URL = "/.netlify/functions/vertrag_senden";

  // pdf.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // ----------------------------
  // DOM
  // ----------------------------
  const topNotice = document.getElementById("topNotice");
  const pdfPages = document.getElementById("pdfPages");
  const pdfHint  = document.getElementById("pdfHint");
  const contractNoHint = document.getElementById("contractNoHint");
  const mailToEl = document.getElementById("mailTo");
  const summaryGrid = document.getElementById("summaryGrid");
  const btnSend = document.getElementById("btnSend");
  const btnBack = document.getElementById("btnBack");
  const errorBox = document.getElementById("errorBox");
  const okBox = document.getElementById("okBox");

  // ----------------------------
  // Helpers
  // ----------------------------
  function safeParse(s){ try{return JSON.parse(s);}catch(e){ return null; } }
  function pick(v, fb="–"){ const s=(v??"").toString().trim(); return s? s : fb; }
  function pad2(n){ return String(n).padStart(2,"0"); }

  function nowStamp(){
    const d = new Date();
    const y = d.getFullYear();
    const m = pad2(d.getMonth()+1);
    const da = pad2(d.getDate());
    const ss = pad2(d.getSeconds());
    const mm = pad2(d.getMinutes());
    return { yyyymmdd: `${y}${m}${da}`, ssmm: `${ss}${mm}` };
  }

  function toEuro(v){
    const n = Number(v);
    if(!isFinite(n)) return "–";
    return n.toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2}) + " €";
  }
  function withVat(net, vat=0.19){
    const n = Number(net);
    if(!isFinite(n)) return NaN;
    return n * (1+vat);
  }

  function n2nl(s){
    return (s ?? "").toString().replace(/\\n/g,"\n").replace(/\r\n/g,"\n");
  }

  async function fetchText(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error("http_" + r.status);
    return await r.text();
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error("http_" + r.status);
    return await r.json();
  }

  async function imgToDataUrl(url){
    // robust: fetch -> blob -> FileReader (kein canvas/cors stress)
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error("logo_http_" + r.status);
    const blob = await r.blob();
    return await new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(fr.result);
      fr.onerror = ()=> reject(new Error("logo_read"));
      fr.readAsDataURL(blob);
    });
  }

  function ssObj(key){
    const o = safeParse(sessionStorage.getItem(key) || "");
    return (o && typeof o === "object") ? o : {};
  }

  function buildContractNumber(rechnNr){
    const rn = pick(rechnNr, "Autom. Vergabe");
    const { yyyymmdd, ssmm } = nowStamp();
    return `${rn}_${rn}_${yyyymmdd}_${ssmm}`;
  }

  // ----------------------------
  // ✅ Wartungsvertrag: JSON sauber rendern (kein rohes JSON)
  // ----------------------------
  async function loadWartung(){
    const raw = n2nl(await fetchText(WARTUNG_TXT_URL)).trim();
    const obj = safeParse(raw);
    if(obj && Array.isArray(obj.sections)){
      return {
        title: pick(obj.title,"Leistungsumfang – Service & Wartung für Kundenrouter"),
        sections: obj.sections.map(s=>({
          heading: pick(s.heading,""),
          text: n2nl(s.text||""),
          note: n2nl(s.note||"")
        }))
      };
    }
    // fallback: plain text
    return { title:"Vertragsbestandteile", sections:[{ heading:"", text: raw, note:"" }] };
  }

  function blocksFromText(t){
    const lines = (t||"").split("\n").map(x=>x.trim()).filter(Boolean);
    const out = [];
    let ul = null;
    for(const line of lines){
      if(/^[•\-–]/.test(line)){
        if(!ul){ ul={ ul:[], margin:[0,2,0,8] }; out.push(ul); }
        ul.ul.push(line.replace(/^[•\-–]\s*/,""));
      }else{
        ul = null;
        out.push({ text: line, style:"p", margin:[0,0,0,6] });
      }
    }
    return out;
  }

  // ----------------------------
  // ✅ AGB: wie aktuelle AGB-Index (GitHub list -> lokale Files)
  // ----------------------------
  function normalizeAgbJsonFiles(rawFiles){
    const out = [];
    rawFiles.forEach(fileObj=>{
      if(!fileObj) return;
      if(fileObj.note) out.push({ isNote:true, text:fileObj.note });
      Object.keys(fileObj).forEach(key=>{
        if(key==="note") return;
        const v = fileObj[key];
        if(Array.isArray(v)) out.push(...v);
        else if(v && typeof v==="object" && (v.title||v.Titel||v.text||v.Text)) out.push(v);
      });
    });
    return out;
  }

  async function loadAgb(){
    const list = await fetchJson(GITHUB_CONTENT_API);
    const files = (list||[])
      .filter(e => e.type==="file" && e.name.toLowerCase().endsWith(".txt"))
      .map(e => e.name)
      .sort();

    const rawFiles = await Promise.all(files.map(async (name)=>{
      try{
        const r = await fetch(AGB_LOCAL_DIR + name, { cache:"no-store" });
        if(!r.ok) return null;
        return await r.json(); // ✅ in deinem System sind das JSON-TXT
      }catch(e){
        return null;
      }
    }));

    return normalizeAgbJsonFiles(rawFiles);
  }

  // ----------------------------
  // ✅ Preisstaffelung "modern": pro Jahr eine Karten-Zeile wie Rechnung
  //    - netto & brutto
  //    - Jahr als Position (z.B. "01 / Jahr 1")
  //    - Jahr-Gesamtpreis (Jahr 1 = Wartung + LANcare, sonst Wartung)
  // ----------------------------
  function buildPriceCards(paket){
    const years = Number(paket.laufzeit_jahre || 0);
    const wartNet = Number(paket.wartungsvertrag_preis_pro_jahr || NaN);
    const lanNet  = Number(paket.lancare_preis_netto || NaN);

    if(!years || !isFinite(years)) return [];

    const cards = [];
    for(let y=1; y<=years; y++){
      const hasLan = (y===1);
      const lanN = hasLan ? lanNet : 0;
      const sumN = (isFinite(wartNet)? wartNet:0) + (isFinite(lanN)? lanN:0);

      cards.push({
        pos: pad2(y),
        label: `Jahr ${y}`,
        lines: [
          { name: "LANcare", net: lanN, brut: withVat(lanN) },
          { name: "Wartungs- & Servicepauschale", net: wartNet, brut: withVat(wartNet) }
        ],
        totalNet: sumN,
        totalBrut: withVat(sumN)
      });
    }
    return cards;
  }

  // ----------------------------
  // PDF Design: moderner Look (Karten statt Tabellen)
  // ----------------------------
  function pill(text){
    return {
      text,
      color:"#0b3a88",
      fillColor:"#eaf2ff",
      fontSize:9,
      bold:true,
      margin:[0,0,0,0]
    };
  }

  function cardBox(stack, opts={}){
    return {
      table:{
        widths:["*"],
        body:[[
          { stack, margin:[12,10,12,10] }
        ]]
      },
      layout:{
        fillColor: ()=> "#ffffff",
        hLineColor: ()=> "#e6ecf7",
        vLineColor: ()=> "#e6ecf7",
        paddingLeft: ()=>0, paddingRight: ()=>0, paddingTop: ()=>0, paddingBottom: ()=>0
      },
      margin: opts.margin || [0,8,0,0]
    };
  }

  function twoColRow(left, right){
    return {
      columns:[
        { width:"48%", stack:left },
        { width:"4%", text:"" },
        { width:"48%", stack:right }
      ],
      margin:[0,0,0,0]
    };
  }

  function field(label, value){
    return {
      stack:[
        { text: label, fontSize:9, color:"#64748b", margin:[0,0,0,2] },
        { text: value, fontSize:11, bold:true, color:"#0f172a" }
      ],
      margin:[0,0,0,8]
    };
  }

  async function buildPdf(analyse, person, paket){
    const contractNo = buildContractNumber(analyse["Rechnungs-Nr."] || analyse["Rechnungs-Nr"] || analyse["RechnungsNr"]);
    contractNoHint.textContent = "Vertragsnummer: " + contractNo;

    const logo = await imgToDataUrl(LOGO_IMG_URL).catch(()=>null);

    const firma = pick(analyse["Firma"]);
    const wpNum = pick(analyse["windpark_nummer"], "000");
    const wpName = pick(analyse["windpark_name"], "Musterpark");
    const wp = `${wpNum} – ${wpName}`;
    const ansp = pick(analyse["Ansprechpartner"]);
    const addr = `${pick(analyse["Straße und Hausnummer"], "")}\n${pick(analyse["PLZ"], "")} ${pick(analyse["Ort"], "")}`.trim();

    const kundeEmail = pick(person.email, "–");
    mailToEl.textContent = kundeEmail;

    const wart = await loadWartung();
    const agb = await loadAgb();
    const priceCards = buildPriceCards(paket);

    // Wartung in Blocks
    const wartBlocks = [];
    wartBlocks.push({ text: wart.title, style:"h2", margin:[0,4,0,6] });
    (wart.sections||[]).forEach(sec=>{
      if(sec.heading) wartBlocks.push({ text: sec.heading, style:"h3", margin:[0,10,0,4] });
      if(sec.text) wartBlocks.push(...blocksFromText(sec.text));
      if(sec.note){
        wartBlocks.push(cardBox([
          { text:"Hinweis", fontSize:9, bold:true, color:"#334155", margin:[0,0,0,4] },
          ...blocksFromText(sec.note).map(b=>({ ...b, color:"#334155" }))
        ], { margin:[0,6,0,0] }));
      }
    });

    // Preisstaffel als "Rechnung": pro Jahr eine Karte mit Position, Leistungen, netto/brutto, Gesamt
    const priceBlocks = [];
    priceBlocks.push({ text:"Preisstaffelung", style:"h2", margin:[0,14,0,6] });
    priceBlocks.push({ text:"Alle Preise pro Jahr. Jahr 1 enthält zusätzlich LANcare (einmalig).", fontSize:9, color:"#64748b", margin:[0,0,0,6] });

    priceCards.forEach(card=>{
      const linesBody = [
        { columns:[
            { width: 42, text: card.pos, style:"pos" },
            { width:"*", stack:[
                { text: card.label, style:"h3", margin:[0,0,0,2] },
                { text: "Leistungen", fontSize:9, color:"#64748b" }
              ]
            }
          ], columnGap: 10, margin:[0,0,0,8]
        },
        {
          table:{
            widths:["*", "auto", "auto"],
            body:[
              [
                { text:"Position", style:"th" },
                { text:"Netto", style:"th", alignment:"right" },
                { text:"Brutto", style:"th", alignment:"right" }
              ],
              ...card.lines.map(l => ([
                { text: l.name, style:"td" },
                { text: toEuro(l.net), style:"td", alignment:"right" },
                { text: isFinite(l.brut) ? toEuro(l.brut) : "–", style:"td", alignment:"right" }
              ])),
              [
                { text:"Gesamt pro Jahr", style:"sumLabel" },
                { text: toEuro(card.totalNet), style:"sum", alignment:"right" },
                { text: isFinite(card.totalBrut) ? toEuro(card.totalBrut) : "–", style:"sum", alignment:"right" }
              ]
            ]
          },
          layout:{
            fillColor:(row)=> row===0 ? "#f3f6ff" : null,
            hLineColor:()=>"#e6ecf7",
            vLineColor:()=>"#e6ecf7",
            paddingLeft:()=>6, paddingRight:()=>6, paddingTop:()=>6, paddingBottom:()=>6
          }
        }
      ];

      priceBlocks.push(cardBox(linesBody, { margin:[0,8,0,0] }));
    });

    // AGB blocks (JSON aus AGB-Loader)
    const agbBlocks = [];
    agbBlocks.push({ text:"Allgemeine Geschäftsbedingungen (AGB)", style:"h2", margin:[0,14,0,6] });

    agb.forEach((item, idx)=>{
      if(item.isNote){
        agbBlocks.push(cardBox([
          { text: n2nl(item.text||""), fontSize:9, color:"#334155" }
        ], { margin:[0,6,0,0] }));
        return;
      }
      const title = pick(item.title || item.Titel || item.heading || item.Heading, "");
      const text  = n2nl(item.text || item.Text || "");
      if(title){
        agbBlocks.push({ text: title, style:"h3", margin:[0,10,0,4] });
      }
      if(text){
        agbBlocks.push(...blocksFromText(text));
      }
    });

    const header = [
      {
        columns:[
          logo ? { image: logo, width: 56, margin:[0,2,10,0] } : { text:"", width: 56 },
          {
            width:"*",
            stack:[
              { text:"Kevin Strakerjahn Networks & Automation", style:"brand" },
              { text:"Bundesstraße 5 6 · 25795 Stelle-Wittenwurth", style:"brandSub" }
            ]
          },
          {
            width:"auto",
            stack:[
              pill("MUSTER • Vorschau"),
              { text:"", margin:[0,6,0,0] },
              { text: contractNo, fontSize:8, color:"#64748b", alignment:"right" }
            ],
            alignment:"right"
          }
        ],
        columnGap: 8,
        margin:[0,0,0,10]
      },
      { text:"Wartungs- & Servicevertrag", style:"h1", margin:[0,0,0,10] }
    ];

    const contractDataCard = cardBox([
      twoColRow(
        [
          field("Vertragsnummer", contractNo),
          field("Windpark", wp),
          field("Firma", firma),
        ],
        [
          field("Ansprechpartner", ansp),
          field("Adresse", addr || "–"),
          field("E-Mail (Kopie)", kundeEmail)
        ]
      )
    ], { margin:[0,0,0,0] });

    const providerCard = cardBox([
      { text:"Vertragsgeber", style:"h2", margin:[0,0,0,6] },
      twoColRow(
        [
          field("Name", "Kevin Strakerjahn Networks & Automation"),
          field("Adresse", "Bundesstraße 5 6\n25795 Stelle-Wittenwurth"),
        ],
        [
          field("E-Mail", "info@netteck.de"),
          field("Telefon", "+49 151 29047232"),
        ]
      )
    ]);

    const doc = {
      pageSize:"A4",
      pageMargins:[40, 48, 40, 52],
      watermark:{
        text:"MUSTER",
        color:"#94a3b8",
        opacity: 0.10,
        bold:true,
        fontSize: 130,
        angle: 45
      },
      footer:(current, pages)=>({
        columns:[
          { text:`Vertragsnr.: ${contractNo}`, fontSize:8, color:"#64748b", margin:[40,0,0,0] },
          { text:`Seite ${current} von ${pages}`, alignment:"right", fontSize:8, color:"#64748b", margin:[0,0,40,0] }
        ],
        margin:[0,0,0,14]
      }),
      styles:{
        brand:{ fontSize:15, bold:true, color:"#0f172a" },
        brandSub:{ fontSize:9, color:"#64748b" },
        h1:{ fontSize:18, bold:true, color:"#0f172a" },
        h2:{ fontSize:12.5, bold:true, color:"#0f172a" },
        h3:{ fontSize:11, bold:true, color:"#0f172a" },
        p:{ fontSize:10.6, color:"#111827", lineHeight:1.25 },
        th:{ fontSize:9.5, bold:true, color:"#0f172a" },
        td:{ fontSize:10.2, color:"#111827" },
        sumLabel:{ fontSize:10.2, bold:true, color:"#0f172a" },
        sum:{ fontSize:10.2, bold:true, color:"#0f172a" },
        pos:{ fontSize:11, bold:true, color:"#0b74ff", alignment:"center", margin:[0,8,0,0] }
      },
      defaultStyle:{ fontSize: 10.6, color:"#111827" },
      content: [
        ...header,
        contractDataCard,
        providerCard,
        { text:"Vertragsbestandteile", style:"h2", margin:[0,14,0,6] },
        ...wartBlocks,
        ...priceBlocks,
        ...agbBlocks
      ]
    };

    return { doc, contractNo, kundeEmail };
  }

  // ----------------------------
  // Render PDF (Canvas) - no toolbar
  // ----------------------------
  async function renderPdfToCanvases(pdfBytes){
    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
    pdfPages.innerHTML = "";

    const wrapW = pdfPages.clientWidth;
    for(let n=1; n<=pdf.numPages; n++){
      const page = await pdf.getPage(n);
      const v1 = page.getViewport({ scale:1 });
      const scale = Math.max(0.9, Math.min(2.1, (wrapW - 2) / v1.width));
      const viewport = page.getViewport({ scale });

      const canvas = document.createElement("canvas");
      canvas.className = "pageCanvas";
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      canvas.addEventListener("contextmenu", e=>e.preventDefault());

      await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
      pdfPages.appendChild(canvas);
    }
  }

  // ----------------------------
  // Summary
  // ----------------------------
  function addKV(k, v){
    const d = document.createElement("div");
    d.className = "kv";
    d.innerHTML = `<b>${k}</b><span>${String(v).replace(/\n/g,"<br>")}</span>`;
    summaryGrid.appendChild(d);
  }

  function setSummary(analyse, person, paket, contractNo){
    summaryGrid.innerHTML = "";
    addKV("Vertragsnummer", contractNo);
    addKV("Windpark", `${pick(analyse["windpark_nummer"],"000")} – ${pick(analyse["windpark_name"],"Musterpark")}`);
    addKV("Firma", pick(analyse["Firma"]));
    addKV("Ansprechpartner", pick(analyse["Ansprechpartner"]));
    addKV("E-Mail", pick(person.email));
    addKV("Laufzeit", pick(paket.laufzeit_jahre) ? `${paket.laufzeit_jahre} Jahre` : "–");
    addKV("Wartung/Jahr (netto)", toEuro(paket.wartungsvertrag_preis_pro_jahr));
    addKV("LANcare (einmalig, netto)", toEuro(paket.lancare_preis_netto));
  }

  // ----------------------------
  // Back / Send
  // ----------------------------
  btnBack.addEventListener("click", ()=>{
    if(window.parent && typeof window.parent.prevStep === "function") window.parent.prevStep();
    else history.back();
  });

  async function sendContract(payload){
    const r = await fetch(NETLIFY_FN_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.message || ("http_" + r.status));
    return data;
  }

  function setSending(on){
    btnSend.disabled = !!on;
    btnSend.textContent = on ? "Wird gesendet…" : "Vertrag anfragen";
  }

  // ----------------------------
  // Init
  // ----------------------------
  (async function init(){
    try{
      const analyse = ssObj(ANALYSE_KEY);
      const person  = ssObj(PERSON_KEY);
      const paket   = ssObj(PAKET_KEY);

      if(person?.email) mailToEl.textContent = person.email;

      const { doc, contractNo } = await buildPdf(analyse, person, paket);

      // pdfMake -> bytes
      const pdfBytes = await new Promise((resolve, reject)=>{
        try{
          pdfMake.createPdf(doc).getBuffer(buf=>{
            try{ resolve(new Uint8Array(buf)); } catch(e){ reject(e); }
          });
        }catch(e){ reject(e); }
      });

      await renderPdfToCanvases(pdfBytes);
      setSummary(analyse, person, paket, contractNo);

      contractNoHint.textContent = "Vertragsnummer: " + contractNo;
      pdfHint.textContent = "Bereit – bitte komplett durchscrollen";
      topNotice.textContent = "PDF ist bereit. Bitte komplett durchscrollen – unten können Sie die Anfrage absenden.";

      btnSend.addEventListener("click", async ()=>{
        errorBox.classList.remove("show");
        okBox.classList.remove("show");

        try{
          setSending(true);
          const payload = {
            contractNumber: contractNo,
            sendCopyToCustomer: !!document.getElementById("sendCopy").checked,
            customerEmail: pick(person.email,""),
            notes: (document.getElementById("notes").value||"").trim(),
            analyse, person, paket
          };
          await sendContract(payload);
          setSending(false);
          okBox.classList.add("show");
          btnSend.style.display = "none";
        }catch(e){
          console.error(e);
          setSending(false);
          errorBox.classList.add("show");
        }
      });

    }catch(e){
      console.error(e);
      topNotice.textContent = "PDF konnte nicht erzeugt werden. Bitte Pfade/Dateien prüfen.";
      topNotice.style.borderColor = "rgba(180,35,24,.25)";
      topNotice.style.background = "rgba(180,35,24,.06)";
      topNotice.style.color = "#7a271a";
      errorBox.classList.add("show");
    }
  })();
</script>
</body>
</html>
