<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Step 5 – Vertrag bestätigen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../../../../Logos/logo.png" />

  <style>
    :root{
      --primary:#0b74ff;
      --primary-soft: rgba(11,116,255,0.10);
      --bg:#f5f7fb;
      --card-bg:#ffffff;
      --border:#e1e4ec;
      --text-main:#1f2933;
      --text-muted:#6b7280;
      --danger:#b42318;
      --ok:#067647;
      --radius-lg:14px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; height:100%; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    .wrap{ max-width: 1100px; margin: 22px auto; padding: 0 14px; }
    .card{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 30px rgba(31,41,51,0.06);
      overflow: hidden;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(11,116,255,0.05), rgba(11,116,255,0));
    }
    .title{ font-size: 18px; font-weight: 750; }
    .sub{ color: var(--text-muted); font-size: 13px; margin-top: 2px; }
    .pill{
      font-size: 12px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.7);
      color: var(--text-muted);
      white-space: nowrap;
    }
    .body{ padding: 16px 18px 18px; }

    .notice{
      border: 1px solid var(--border);
      background: rgba(11,116,255,0.06);
      padding: 12px 12px;
      border-radius: 12px;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 14px;
    }

    .pdfBox{
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
    }
    .pdfTop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(245,247,251,0.7);
    }
    .pdfTop .left{
      display:flex; flex-direction:column;
    }
    .pdfTop .left strong{ font-size: 13px; }
    .pdfTop .left span{ font-size: 12px; color: var(--text-muted); }
    .pdfTop .right{
      display:flex; gap:8px; align-items:center;
      font-size: 12px; color: var(--text-muted);
    }
    .loaderDot{
      width: 8px; height: 8px; border-radius: 999px; background: var(--primary);
      box-shadow: 0 0 0 6px rgba(11,116,255,0.12);
      animation: pulse 1.2s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity: 1; }
      50%{ transform: scale(1.35); opacity: .65; }
    }
    iframe{
      display:block;
      width: 100%;
      height: 78vh;
      border: 0;
      background: #fff;
    }

    .actions{
      margin-top: 14px;
      border-top: 1px dashed var(--border);
      padding-top: 14px;
    }
    label{ display:block; font-size: 13px; font-weight: 650; margin: 8px 0 6px; }
    textarea,input{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    textarea{ min-height: 110px; resize: vertical; }
    .row{ display:flex; gap: 12px; align-items:flex-start; flex-wrap:wrap; }
    .row > .col{ flex:1 1 320px; min-width: 260px; }
    .checkRow{
      display:flex; align-items:center; gap:10px;
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(245,247,251,0.6);
    }
    .checkRow input[type="checkbox"]{ width: 18px; height: 18px; margin:0; }
    .hint{
      color: var(--text-muted);
      font-size: 12.5px;
      line-height: 1.45;
      margin-top: 10px;
      padding: 10px 12px;
      border-left: 4px solid rgba(11,116,255,0.35);
      background: rgba(11,116,255,0.04);
      border-radius: 10px;
    }
    .btnRow{ display:flex; gap: 10px; margin-top: 12px; flex-wrap:wrap; }
    button{
      border: 0;
      border-radius: 12px;
      padding: 11px 14px;
      font-weight: 750;
      cursor: pointer;
      font-size: 14px;
    }
    .btnPrimary{
      background: var(--primary);
      color: #fff;
      box-shadow: 0 10px 22px rgba(11,116,255,0.25);
    }
    .btnGhost{
      background: #fff;
      border: 1px solid var(--border);
      color: var(--text-main);
    }
    .btnPrimary:disabled{
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display:none;
      font-size: 13px;
      line-height: 1.4;
    }
    .status.show{ display:block; }
    .status.ok{ border-color: rgba(6,118,71,0.35); background: rgba(6,118,71,0.06); color: var(--ok); }
    .status.err{ border-color: rgba(180,35,24,0.35); background: rgba(180,35,24,0.06); color: var(--danger); }

    .smallMono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Vertragsvorlage (Muster) – Vorschau</div>
          <div class="sub">Bitte vollständig durchscrollen und unten die Anfrage absenden.</div>
        </div>
        <div class="pill smallMono" id="contractNoPill">Vertragsnr.: …</div>
      </div>

      <div class="body">
        <div class="notice" id="noticeBox">
          Die PDF wird automatisch erzeugt. Falls Inhalte fehlen, bitte vorherige Steps prüfen.
        </div>

        <div class="pdfBox">
          <div class="pdfTop">
            <div class="left">
              <strong>PDF Vorschau</strong>
              <span id="pdfMetaLine">Wird erstellt…</span>
            </div>
            <div class="right" id="pdfLoading">
              <div class="loaderDot"></div>
              <span>Erzeuge Muster-PDF…</span>
            </div>
          </div>
          <iframe id="pdfFrame" title="Vertragsvorschau"></iframe>
        </div>

        <div class="actions" id="actions">
          <div class="row">
            <div class="col">
              <label for="notes">Anmerkungen zu Ihrer Vertragsvorlage</label>
              <textarea id="notes" placeholder="Optional: z. B. abweichender Windparkname, besondere Anforderungen, Ansprechpartnerwechsel …"></textarea>
            </div>
            <div class="col">
              <div class="checkRow">
                <input type="checkbox" id="sendCopy" />
                <div>
                  <div style="font-weight:750; font-size:13px;">Möchten Sie das Muster als Kopie per E-Mail erhalten?</div>
                  <div style="color:var(--text-muted); font-size:12.5px;">Wenn aktiv, senden wir das Muster-PDF an diese Adresse.</div>
                </div>
              </div>

              <label for="copyEmail" style="margin-top:10px;">E-Mail-Adresse</label>
              <input id="copyEmail" type="email" placeholder="name@firma.de" autocomplete="email" />
            </div>
          </div>

          <div class="hint">
            Nach dem Absenden erhalten wir Ihre Vertragsvorlage und werden diese prüfen. Wenn alles korrekt ist, erhalten Sie anschließend die Vertragsvorlage zur Unterschrift oder zur schriftlich eindeutigen Bestätigung.
            Bis zum Zeitpunkt der Bestätigung ist die Vorlage für beide Parteien unverbindlich.
          </div>

          <div class="btnRow">
            <button class="btnPrimary" id="btnRequest" disabled>Vertrag anfragen</button>
            <button class="btnGhost" id="btnBack">Zurück</button>
          </div>

          <div class="status" id="statusBox"></div>

          <div class="btnRow" id="doneRow" style="display:none;">
            <button class="btnPrimary" id="btnHome">Zur Startseite (netteck.de)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  Konfiguration (bei Bedarf anpassen)
 *  ========================= */
const LOGO_PATH = "../../../../Logos/logo_name.jpeg"; // wie in deiner AGB-PDF (anpassen, falls Pfad anders)
const WARUNGVERTRAG_TXT = "/netteck.de/aktuelles/enercon_kundenrouter_wartung/information/warungsvertrag.txt";

// AGB-Quelle wie in AGB/index.html (meta.json + Dateien in AGBs/)
const AGB_META_URL = "AGBs/meta.json";      // ggf. relativ anpassen
const AGB_BASE_DIR = "AGBs/";               // Ordner der AGB-Textdateien

const STORAGE_ANALYSE = "rechnungAnalyse";
const STORAGE_PERSON  = "personConfirm";
const STORAGE_PAKET   = "paketWahl";

const NETLIFY_FN_URL = "/.netlify/functions/vertrag-versenden";
const INTERNAL_TARGET = "info@netteck.de";

/** Vertragsgeber (deine Daten) */
const VERTRAGSGEBER = {
  name: "Kevin Strakerjahn Networks & Automation",
  street: "—",
  zipCity: "—",
  email: "info@netteck.de",
  phone: "—"
};

/** =========================
 *  Helpers
 *  ========================= */
function safeParse(s){ try { return JSON.parse(s); } catch(e){ return null; } }
function pad2(n){ return String(n).padStart(2,"0"); }
function nowStamp(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = pad2(d.getMonth()+1);
  const dd = pad2(d.getDate());
  const hh = pad2(d.getHours());
  const mi = pad2(d.getMinutes());
  return { d, ymd: `${yyyy}${mm}${dd}`, hm: `${hh}${mi}` };
}
function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||"").trim()); }
function setStatus(type, text){
  const box = document.getElementById("statusBox");
  box.className = "status show " + (type==="ok" ? "ok" : "err");
  box.textContent = text;
}
function clearStatus(){
  const box = document.getElementById("statusBox");
  box.className = "status";
  box.textContent = "";
}
async function fetchText(url){
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error(`Fetch fehlgeschlagen: ${url} (${r.status})`);
  return await r.text();
}
async function loadLogoDataUrl(){
  // Canvas-Konvertierung wie in deiner AGB-index.html (robust)
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      try{
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL("image/jpeg", 0.92));
      }catch(e){
        resolve(null);
      }
    };
    img.onerror = () => resolve(null);
    img.src = LOGO_PATH;
  });
}

/** Text → pdfMake Blocks (ähnlich deiner AGB-Seite) */
function textToPdfBlocks(raw){
  const out = [];
  const txt = (raw || "").replace(/\r/g,"").trim();
  if(!txt) return out;

  // Absätze
  const paras = txt.split(/\n{2,}/g).map(p=>p.trim()).filter(Boolean);

  for(const p of paras){
    const lines = p.split("\n").map(l=>l.trim()).filter(Boolean);

    // Headline-Heuristik: kurze Zeile ohne Punkt am Ende
    if(lines.length===1 && lines[0].length < 80 && !/[.!?]$/.test(lines[0])){
      out.push({ text: lines[0], style: "h2", margin: [0, 10, 0, 6] });
      continue;
    }

    // Bullet-List erkennen
    const bullets = [];
    const normal = [];

    for(const l of lines){
      if(/^(\u2022|\-|\–)\s+/.test(l)){
        bullets.push(l.replace(/^(\u2022|\-|\–)\s+/,"").trim());
      } else {
        normal.push(l);
      }
    }

    if(normal.length){
      out.push({ text: normal.join("\n"), margin: [0, 0, 0, 6] });
    }
    if(bullets.length){
      out.push({ ul: bullets, margin: [0, 0, 0, 6] });
    }
  }
  return out;
}

/** AGB laden wie in AGB/index.html: meta.json -> agb_files (oder fallback) */
async function loadAgbTexts(){
  let meta = null;
  try{
    const r = await fetch(AGB_META_URL, { cache:"no-store" });
    if(r.ok) meta = await r.json();
  }catch(e){ /* ignore */ }

  const fallback = [
    "01_geltungsbereich.txt",
    "02_vertragsschluss.txt",
    "03_mitwirkungspflichten.txt",
    "04_ruecktritt.txt",
    "05_leistungsnachweise.txt",
    "06_liefer_ausfuehrungs_einsatzzeiten.txt",
    "07_gewaehrleistung.txt",
    "08_haftung.txt",
    "09_preise_und_zahlungen.txt",
    "10_eigentumsvorbehalt.txt",
    "11_gerichtssand_anwendbares_recht.txt"
  ];

  const files = (meta && Array.isArray(meta.agb_files) && meta.agb_files.length) ? meta.agb_files : fallback;

  const blocks = [];
  for(const f of files){
    try{
      const t = await fetchText(AGB_BASE_DIR + f);
      // Dateiname als Überschrift (wenn meta Titel liefert, könntest du das hier ersetzen)
      const nice = f.replace(/^\d+_/, "").replace(/\.txt$/,"").replace(/_/g," ");
      blocks.push({ text: nice.toUpperCase(), style:"h2", margin:[0,10,0,6] });
      blocks.push(...textToPdfBlocks(t));
    }catch(e){
      // wenn eine Datei fehlt: überspringen (damit Step5 trotzdem funktioniert)
    }
  }
  return blocks;
}

/** Preisstaffel aus paketWahl (sehr tolerant) */
function buildPriceTable(paket){
  const items = [];
  if(!paket || typeof paket!=="object") return items;

  // Erwartung (tolerant): paket.years / paket.laufzeit / paket.duration, und Zahlenfelder
  const years = Number(paket.years || paket.laufzeit || paket.duration || 3);
  const lancare = paket.lancare_price ?? paket.lancare ?? paket.LANCare ?? null;

  // Wartung pro Jahr kann als Array oder Feld kommen
  const maintArr = Array.isArray(paket.maintenance_by_year) ? paket.maintenance_by_year
                 : Array.isArray(paket.wartung_by_year) ? paket.wartung_by_year
                 : null;

  const maintY1 = paket.maintenance_year1 ?? paket.wartung_year1 ?? paket.wartung ?? null;

  for(let y=1; y<=years; y++){
    items.push({ text: `Jahr ${y}`, style:"h2", margin:[0, 10, 0, 6] });

    if(y===1 && lancare!=null){
      items.push({ text: `LANcare: ${String(lancare)}€`, margin:[0,0,0,2] });
    }
    const mw = (maintArr && maintArr[y-1]!=null) ? maintArr[y-1] : (y===1 ? maintY1 : (paket[`maintenance_year${y}`] ?? paket[`wartung_year${y}`] ?? null));
    if(mw!=null){
      items.push({ text: `Wartungs & Servicepauschale: ${String(mw)}€`, margin:[0,0,0,2] });
    } else {
      items.push({ text: `Wartungs & Servicepauschale: —`, color:"#6b7280", margin:[0,0,0,2] });
    }
  }
  return items;
}

/** Daten aus Steps mergen + Vertragsnummer bauen */
function buildContractData(){
  const analyse = safeParse(sessionStorage.getItem(STORAGE_ANALYSE) || "") || {};
  const person  = safeParse(sessionStorage.getItem(STORAGE_PERSON)  || "") || {};
  const paket   = safeParse(sessionStorage.getItem(STORAGE_PAKET)   || "") || {};

  const reNr = (analyse["Rechnungs-Nr."] || analyse["Rechnungs-Nr"] || analyse["RechnungsNr"] || "Autom. Vergabe").toString().trim();
  const { ymd, hm } = nowStamp();
  const contractNo = `${reNr}_${reNr}_${ymd}_${hm}`;

  // Wichtige Daten (dein Muster: Windpark fix)
  const firm = (analyse["Firma"] || person.company || "").toString().trim();
  const contact = (analyse["Ansprechpartner"] || [person.firstName, person.lastName].filter(Boolean).join(" ") || "").toString().trim();
  const street = (analyse["Straße und Hausnummer"] || analyse["Straße"] || "").toString().trim();
  const plz = (analyse["PLZ"] || "").toString().trim();
  const city = (analyse["Ort"] || "").toString().trim();

  return {
    contractNo,
    windpark: "000-Musterpark",
    firma: firm,
    ansprechpartner: contact,
    adresse: [street, [plz, city].filter(Boolean).join(" ")].filter(Boolean).join(", "),
    analyse, person, paket
  };
}

/** =========================
 *  PDF Builder
 *  ========================= */
async function buildPdfDocDefinition({ contract, warungsvertragText, agbBlocks, withWatermark }){
  const logoDataUrl = await loadLogoDataUrl();

  const headerBlocks = [
    (logoDataUrl ? { image: logoDataUrl, width: 520, alignment: "center", margin: [0,0,0,12] } : null),
    { text: "Wartungs- & Servicevertrag (Vorschau)", style: "h1", margin: [0, 0, 0, 8] },

    { text: "Wichtige Vertragsdaten", style: "h2", margin: [0, 6, 0, 6] },
    {
      table: {
        widths: ["34%", "*"],
        body: [
          ["Vertragsnummer", contract.contractNo],
          ["Windpark", contract.windpark],
          ["Firma", contract.firma || "—"],
          ["Ansprechpartner", contract.ansprechpartner || "—"],
          ["Adresse", contract.adresse || "—"],
        ]
      },
      layout: "lightHorizontalLines",
      fontSize: 10,
      margin: [0, 0, 0, 10]
    },

    { text: "Vertragsgeber", style: "h2", margin: [0, 2, 0, 6] },
    {
      table: {
        widths: ["34%", "*"],
        body: [
          ["Name", VERTRAGSGEBER.name],
          ["Adresse", [VERTRAGSGEBER.street, VERTRAGSGEBER.zipCity].filter(Boolean).join(", ")],
          ["E-Mail", VERTRAGSGEBER.email],
          ["Telefon", VERTRAGSGEBER.phone],
        ]
      },
      layout: "lightHorizontalLines",
      fontSize: 10,
      margin: [0, 0, 0, 12]
    }
  ].filter(Boolean);

  const content = [];
  content.push(...headerBlocks);

  content.push({ text: "Vertragsbestandteile", style: "h2", margin: [0, 6, 0, 6] });
  content.push(...textToPdfBlocks(warungsvertragText));

  content.push({ text: "Preisstaffelung", style: "h2", margin: [0, 10, 0, 6] });
  content.push(...buildPriceTable(contract.paket));

  content.push({ text: "AGB", style: "h2", margin: [0, 12, 0, 6] });
  content.push(...agbBlocks);

  const dd = {
    pageSize: "A4",
    pageMargins: [40, 60, 40, 60],
    defaultStyle: { fontSize: 11 },
    styles: {
      h1: { fontSize: 18, bold: true },
      h2: { fontSize: 13, bold: true },
      meta: { fontSize: 9, color: "#6b7280" }
    },
    watermark: withWatermark ? { text: "MUSTER", color: "gray", opacity: 0.12, bold: true, italics: false } : undefined,
    footer: function(currentPage, pageCount){
      return {
        margin: [40, 0, 40, 18],
        fontSize: 9,
        color: "#6b7280",
        stack: [
          {
            columns: [
              { text: `${VERTRAGSGEBER.name} · ${VERTRAGSGEBER.email}`, alignment: "left" },
              { text: `Seite ${currentPage} von ${pageCount}`, alignment: "right" }
            ]
          },
          { text: `Vertragsnr.: ${contract.contractNo}`, alignment: "center", margin: [0, 6, 0, 0], color: "#9ca3af" }
        ]
      };
    },
    content
  };

  return dd;
}

/** =========================
 *  Versand
 *  ========================= */
async function sendViaNetlify({ to, subject, message, meta, pdfBase64 }){
  const r = await fetch(NETLIFY_FN_URL, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      to, subject, message, meta,
      pdf_base64: pdfBase64
    })
  });
  const data = await r.json().catch(()=> ({}));
  if(!r.ok || !data.ok){
    throw new Error(data.message || "Versand fehlgeschlagen");
  }
  return data;
}

/** =========================
 *  Init
 *  ========================= */
let CONTRACT = null;
let PDF_BASE64_MUSTER = "";
let PDF_BASE64_CLEAN = "";

function setPdfLoading(on){
  document.getElementById("pdfLoading").style.display = on ? "flex" : "none";
  document.getElementById("pdfMetaLine").textContent = on ? "Wird erstellt…" : "Bereit – bitte komplett durchscrollen";
}

function validateActions(){
  const btn = document.getElementById("btnRequest");
  const copyOn = document.getElementById("sendCopy").checked;
  const email = document.getElementById("copyEmail").value.trim();

  // Anfrage ist erst möglich wenn:
  // - PDF ist fertig
  // - und wenn Kopie aktiv -> gültige Mail
  const pdfReady = !!PDF_BASE64_MUSTER && !!PDF_BASE64_CLEAN;
  const ok = pdfReady && (!copyOn || isEmail(email));
  btn.disabled = !ok;
}

(async function init(){
  clearStatus();

  CONTRACT = buildContractData();
  document.getElementById("contractNoPill").textContent = `Vertragsnr.: ${CONTRACT.contractNo}`;
  setPdfLoading(true);

  try{
    const [warungsvertragText, agbBlocks] = await Promise.all([
      fetchText(WARUNGVERTRAG_TXT).catch(()=> ""),
      loadAgbTexts()
    ]);

    // 1) Muster-PDF (mit MUSTER Wasserzeichen)
    const ddMuster = await buildPdfDocDefinition({
      contract: CONTRACT,
      warungsvertragText,
      agbBlocks,
      withWatermark: true
    });

    // 2) Clean-PDF (ohne MUSTER) für info@netteck.de
    const ddClean = await buildPdfDocDefinition({
      contract: CONTRACT,
      warungsvertragText,
      agbBlocks,
      withWatermark: false
    });

    // Vorschau direkt aus Muster-PDF
    await new Promise((resolve, reject) => {
      pdfMake.createPdf(ddMuster).getDataUrl((dataUrl) => {
        try{
          document.getElementById("pdfFrame").src = dataUrl;
          resolve();
        }catch(e){ reject(e); }
      });
    });

    // Base64 für Versand vorbereiten (beide Varianten)
    PDF_BASE64_MUSTER = await new Promise((resolve) => {
      pdfMake.createPdf(ddMuster).getBase64((b64) => resolve(b64 || ""));
    });
    PDF_BASE64_CLEAN = await new Promise((resolve) => {
      pdfMake.createPdf(ddClean).getBase64((b64) => resolve(b64 || ""));
    });

    setPdfLoading(false);
    validateActions();
  }catch(e){
    setPdfLoading(false);
    setStatus("err", "PDF konnte nicht erzeugt werden: " + (e && e.message ? e.message : String(e)));
    document.getElementById("btnRequest").disabled = true;
  }

  document.getElementById("sendCopy").addEventListener("change", validateActions);
  document.getElementById("copyEmail").addEventListener("input", validateActions);

  document.getElementById("btnBack").addEventListener("click", () => {
    if (window.parent && typeof window.parent.prevStep === "function") window.parent.prevStep();
    else history.back();
  });

  document.getElementById("btnHome").addEventListener("click", () => {
    window.location.href = "https://netteck.de";
  });

  document.getElementById("btnRequest").addEventListener("click", async () => {
    clearStatus();
    document.getElementById("btnRequest").disabled = true;

    const notes = document.getElementById("notes").value.trim();
    const wantCopy = document.getElementById("sendCopy").checked;
    const copyEmail = document.getElementById("copyEmail").value.trim();

    const subjectCustomer = `Vertragsvorlage (MUSTER) – ${CONTRACT.contractNo}`;
    const subjectInternal = `Vertragsanfrage – ${CONTRACT.contractNo}`;

    const meta = {
      contractNo: CONTRACT.contractNo,
      windpark: CONTRACT.windpark,
      firma: CONTRACT.firma,
      ansprechpartner: CONTRACT.ansprechpartner,
      adresse: CONTRACT.adresse,
      notes,
      personConfirm: CONTRACT.person,
      rechnungAnalyse: CONTRACT.analyse,
      paketWahl: CONTRACT.paket
    };

    try{
      // 1) intern immer (ohne MUSTER)
      await sendViaNetlify({
        to: INTERNAL_TARGET,
        subject: subjectInternal,
        message:
          `Neue Vertragsanfrage.\n\n` +
          `Vertragsnr.: ${CONTRACT.contractNo}\n` +
          `Firma: ${CONTRACT.firma}\n` +
          `Ansprechpartner: ${CONTRACT.ansprechpartner}\n` +
          `Adresse: ${CONTRACT.adresse}\n` +
          `Windpark: ${CONTRACT.windpark}\n\n` +
          (notes ? `Anmerkungen:\n${notes}\n\n` : "") +
          `Hinweis: PDF ohne MUSTER im Anhang.`,
        meta,
        pdfBase64: PDF_BASE64_CLEAN
      });

      // 2) Kunde nur wenn gewünscht + gültige Mail
      if (wantCopy){
        if (!isEmail(copyEmail)) throw new Error("Bitte gültige E-Mail für die Kopie eintragen.");
        await sendViaNetlify({
          to: copyEmail,
          subject: subjectCustomer,
          message:
            `Vielen Dank.\n\n` +
            `Im Anhang erhalten Sie die Vertragsvorlage als MUSTER-Kopie.\n` +
            `Vertragsnr.: ${CONTRACT.contractNo}\n\n` +
            `Hinweis: Bis zur finalen Bestätigung ist die Vorlage für beide Parteien unverbindlich.`,
          meta,
          pdfBase64: PDF_BASE64_MUSTER
        });
      }

      setStatus("ok", "Ihre Anfrage wurde übermittelt.");
      document.getElementById("doneRow").style.display = "flex";
    }catch(e){
      setStatus("err", e && e.message ? e.message : String(e));
      validateActions();
    }
  });
})();
</script>
</body>
</html>
