<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Step 4 – Paket wählen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../../../../Logos/logo.png" />

  <style>
    :root {
      --primary:#0b74ff;
      --primary2:#7a5cff;
      --primary-soft: rgba(11, 116, 255, 0.10);
      --bg:#f5f7fb;
      --card-bg:#ffffff;
      --border:#e1e4ec;
      --text-main:#1f2933;
      --text-muted:#6b7280;
      --danger:#b42318;
      --radius-lg:14px;
    }
    *{ box-sizing:border-box; }
    html, body{ margin:0; padding:0; height:100%; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      line-height: 1.6;
      overflow:hidden;
    }
    .viewport{
      height:100vh;
      width:100vw;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 2rem 1rem;
    }
    .card{
      width:min(1100px, 100%);
      height:100%;
      max-height: calc(100vh - 4rem);
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      border: 1px solid var(--border);
      padding: 1.6rem 1.9rem 1.6rem;
      display:flex;
      flex-direction:column;
      gap: 1rem;
    }
    h1{ margin:0; font-size:1.45rem; text-align:center; letter-spacing:.2px; }
    .sub{ margin:0; text-align:center; color:var(--text-muted); font-size:.95rem; }

    .panel{
      flex:1;
      border:1px solid var(--border);
      border-radius: 16px;
      background:#fff;
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      overflow:auto;
    }

    .sectionTitle{ font-weight:950; margin:0; }
    .hint{ margin:0; color:var(--text-muted); font-size:.93rem; }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text-main);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .chip:hover{
      transform: translateY(-1px);
      border-color: var(--primary);
      box-shadow: 0 0 0 5px var(--primary-soft);
    }
    .chip.active{
      border-color: rgba(11,116,255,0.45);
      background: rgba(11,116,255,0.10);
      color:#0b3d91;
    }

    .box{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: #fff;
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
    }
    th, td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(225,228,236,0.7);
      text-align:left;
      font-size: .95rem;
    }
    th{ background: #f9fafb; font-weight: 950; }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; white-space:nowrap; }
    .muted{ color:var(--text-muted); }

    .sumRow{
      display:flex;
      justify-content: space-between;
      align-items:flex-end;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .sumBox{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      background:#fff;
      min-width: 260px;
    }
    .sumLabel{ font-weight:900; }
    .sumValue{ font-size: 1.2rem; font-weight: 950; }

    .error{
      display:none;
      border: 1px solid #ffd0d0;
      background:#fff5f5;
      color: var(--danger);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 850;
      text-align:center;
    }
    .error.show{ display:block; }

    .footer{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      padding-top: 6px;
      border-top: 1px solid rgba(225,228,236,0.8);
    }
    .btn{
      border:none;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.02);
      box-shadow: 0 0 0 5px var(--primary-soft);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      filter:none !important;
      box-shadow:none !important;
    }
    .btnPrimary{ color:#fff; background: linear-gradient(135deg, var(--primary), var(--primary2)); }
    .btnGhost{ background:#fff; color: var(--text-main); border: 1px solid var(--border); }
  </style>
</head>

<body>
  <div class="viewport">
    <div class="card" role="main" aria-label="Paket wählen">
      <h1>Paket wählen</h1>
      <p class="sub">Bitte wählen Sie ihre gewünschte Laufzeit aus</p>

      <div class="panel">
        <div class="box">
          <p class="sectionTitle">Vertragslänge</p>
          <p class="hint">
            Hinweis: jährliche Kündigungsmöglichkeit mit <b>1 Monat</b> Kündigungsfrist.
            Eine nachträgliche Verlängerung ist nicht möglich (bzw. nur zu anderen Konditionen).
          </p>
          <div class="chips" id="lenChips"></div>
        </div>

        <div class="box" id="lancareBox" style="display:none;">
          <p class="sectionTitle">LANcare-Laufzeit</p>
          <p class="hint">Bitte wählen Sie anschließend die gewünschte LANcare-Laufzeit.</p>
          <div class="chips" id="lanChips"></div>
        </div>

        <div class="error" id="errorBox"></div>

        <div class="box" id="summaryBox" style="display:none;">
          <p class="sectionTitle">Ihre Auswahl</p>
          <p class="hint">Jahr 1 enthält LANcare + Service &amp; Wartung. Ab Jahr 2 nur noch Service &amp; Wartung. Abrechnung erfolgt jährlich.</p>

          <div id="tableWrap"></div>

          <div class="sumRow">
            <div class="sumBox">
              <div class="sumLabel">Durchschnitt pro Jahr</div>
              <div class="sumValue" id="avgPrice">–</div>
              <div class="muted" style="font-size:.9rem;">Abrechnung jährlich</div>
            </div>
            <div class="sumBox">
              <div class="sumLabel">Gesamtpreis (Netto)</div>
              <div class="sumValue" id="totalPrice">–</div>
              <div class="muted" style="font-size:.9rem;">Abrechnung jährlich</div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="muted" style="font-size:.9rem;">Auswahl wird für den Vertragsentwurf übernommen.</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btnGhost" type="button" onclick="goBack()">Zurück</button>
          <button class="btn btnPrimary" id="continueBtn" type="button" onclick="continueNext()" disabled>Weiter</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // robust: resolve relative URL from current file location
    const PRICES_URL = new URL("../information/warungsvertrag_preise.txt", window.location.href).toString();
    const STORAGE_KEY = "paketWahl";

    let priceData = null;
    let selectedYears = null;      // 1/3/5
    let selectedLanYears = null;   // depends

    const lenChips = document.getElementById("lenChips");
    const lanChips = document.getElementById("lanChips");
    const lancareBox = document.getElementById("lancareBox");
    const summaryBox = document.getElementById("summaryBox");
    const tableWrap = document.getElementById("tableWrap");
    const avgPrice = document.getElementById("avgPrice");
    const totalPrice = document.getElementById("totalPrice");
    const continueBtn = document.getElementById("continueBtn");
    const errorBox = document.getElementById("errorBox");

    function euro(v){
      if (typeof v !== "number" || !isFinite(v)) return "–";
      return v.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
    }

    function setError(msg){
      if (!msg){
        errorBox.classList.remove("show");
        errorBox.textContent = "";
        return;
      }
      errorBox.classList.add("show");
      errorBox.textContent = msg;
    }

    async function loadPrices(){
      const resp = await fetch(PRICES_URL, { cache: "no-store" });
      if (!resp.ok) throw new Error("preise_laden_fehlgeschlagen");
      const text = await resp.text();
      return JSON.parse(text);
    }

    function buildLengthChips(){
      lenChips.innerHTML = "";
      const keys = Object.keys(priceData.pakete || {}).sort((a,b)=>Number(a)-Number(b));
      keys.forEach(k => {
        const years = Number(k);
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip" + (selectedYears === years ? " active" : "");
        chip.textContent = years + " Jahr" + (years>1 ? "e" : "");
        chip.addEventListener("click", () => {
          selectedYears = years;
          selectedLanYears = null;
          setError("");
          buildLengthChips();
          buildLanChips();
          renderSummary();
        });
        lenChips.appendChild(chip);
      });
    }

    function buildLanChips(){
      if (!selectedYears){
        lancareBox.style.display = "none";
        lanChips.innerHTML = "";
        return;
      }
      lancareBox.style.display = "block";
      lanChips.innerHTML = "";

      const pkg = priceData.pakete[String(selectedYears)];
      const vars = (pkg && pkg.varianten) ? pkg.varianten : [];
      vars.forEach(v => {
        const lanYears = Number(v.lancare_jahre);
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip" + (selectedLanYears === lanYears ? " active" : "");
        chip.textContent = lanYears + " Jahr" + (lanYears>1 ? "e" : "") + " LANcare";
        chip.addEventListener("click", () => {
          selectedLanYears = lanYears;
          setError("");
          buildLanChips();
          renderSummary();
        });
        lanChips.appendChild(chip);
      });
    }

    function getSelectedVariant(){
      if (!selectedYears || !selectedLanYears) return null;
      const pkg = priceData.pakete[String(selectedYears)];
      const vars = (pkg && pkg.varianten) ? pkg.varianten : [];
      return vars.find(v => Number(v.lancare_jahre) === Number(selectedLanYears)) || null;
    }

    function renderSummary(){
      const variant = getSelectedVariant();
      if (!variant){
        summaryBox.style.display = "none";
        tableWrap.innerHTML = "";
        avgPrice.textContent = "–";
        totalPrice.textContent = "–";
        continueBtn.disabled = true;
        return;
      }

      summaryBox.style.display = "block";
      continueBtn.disabled = false;

      const years = Number(selectedYears);
      const wartJahr = Number(variant.wartungsvertrag_preis);
      const lanOnce = Number(variant.lancare_preis_netto);
      const total = Number(variant.gesamt);
      const avg = total / years;

      let rows = "";
      for (let y=1; y<=years; y++){
        const lan = (y===1) ? lanOnce : 0;
        const sum = wartJahr + lan;
        rows += `
          <tr>
            <td>Jahr ${y}</td>
            <td class="right">${euro(lan)}</td>
            <td class="right">${euro(wartJahr)}</td>
            <td class="right"><b>${euro(sum)}</b></td>
          </tr>
        `;
      }

      tableWrap.innerHTML = `
        <table aria-label="Preisübersicht">
          <thead>
            <tr>
              <th>Jahr</th>
              <th class="right">LANcare (Netto)</th>
              <th class="right">Service &amp; Wartung (Netto)</th>
              <th class="right">Summe (Netto)</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      avgPrice.textContent = euro(avg);
      totalPrice.textContent = euro(total);

      const payload = {
        laufzeit_jahre: years,
        lancare_jahre: Number(variant.lancare_jahre),
        wartungsvertrag_preis_pro_jahr: wartJahr,
        lancare_preis_netto: lanOnce,
        lancare_preis_brutto: Number(variant.lancare_preis_brutto),
        gesamt_netto: total,
        durchschnitt_pro_jahr_netto: avg
      };
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function continueNext(){
      if (continueBtn.disabled){
        setError("Bitte wählen Sie zuerst die Vertragslänge und eine LANcare-Variante.");
        return;
      }
      if (window.parent && typeof window.parent.nextStep === "function") window.parent.nextStep();
    }

    function goBack(){
      if (window.parent && typeof window.parent.prevStep === "function") window.parent.prevStep();
    }

    (async function init(){
      try {
        priceData = await loadPrices();

        // restore previous choice
        const savedRaw = sessionStorage.getItem(STORAGE_KEY);
        if (savedRaw){
          try {
            const saved = JSON.parse(savedRaw);
            if (saved && saved.laufzeit_jahre){
              selectedYears = Number(saved.laufzeit_jahre);
              selectedLanYears = Number(saved.lancare_jahre);
            }
          } catch(e){}
        }

        buildLengthChips();
        buildLanChips();
        renderSummary();
      } catch(e){
        console.error(e);
        setError("Preisdaten konnten nicht geladen werden. Bitte prüfen Sie den Pfad zur Datei „warungsvertrag_preise.txt“.");
      }
    })();
  </script>
</body>
</html>
