<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status – Kevin Strakerjahn Networks &amp; Automation</title>
  <style>
    :root{
      --primary:#0b74ff;
      --primary-soft: rgba(11,116,255,.08);
      --bg:#f5f7fb;
      --card-bg:#ffffff;
      --border:#e1e4ec;
      --text-main:#1f2933;
      --text-muted:#6b7280;
      --radius-lg:14px;

      --success:#16a34a;
      --success-soft: rgba(22,163,74,.10);
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:var(--bg);
      color:var(--text-main);
      line-height:1.6;
    }
    img{max-width:100%;height:auto;display:block}
    .page{max-width:1100px;margin:2rem auto 3rem;padding:0 1rem}
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:0 10px 30px rgba(15,23,42,.06);
      padding:1.75rem 1.9rem 2.1rem;
      border:1px solid var(--border);
    }

    /* HEADER BILD wie Hauptseite */
    .header{margin-bottom:1.25rem}
    .logo-wrapper{width:100%}
    .logo-wrapper img{
      width:100%;
      height:auto;
      border-radius:10px;
      object-fit:cover;
    }

    /* Intro */
    .intro{margin-bottom:1.0rem}
    .intro h1{font-size:1.5rem;margin:0 0 .4rem}
    .intro p{margin:.1rem 0;color:var(--text-muted);font-size:.95rem}

    /* Statusliste */
    .status-list{margin:0;padding:0;list-style:none;display:grid;gap:10px}
    .status-item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      background:#fff;
      display:grid;
      gap:6px;
    }
    .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .left{display:flex;align-items:center;gap:10px;min-width:0}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(107,114,128,.45);flex:0 0 10px}
    .status-title{font-weight:700;color:var(--text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .status-desc{color:var(--text-muted);font-size:13px;line-height:1.35}
    .badge{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--text-muted);
      background:#fff;
      flex:0 0 auto;
    }

    /* Erledigt (inkl. aktueller Status) = grün */
    .is-done{
      border-color: rgba(22,163,74,.35);
      background: var(--success-soft);
    }
    .is-done .dot{background:var(--success)}
    .is-done .badge{
      border-color: rgba(22,163,74,.35);
      color: var(--success);
      background: rgba(22,163,74,.08);
      font-weight:700;
    }

    /* Wartungsvertrag-Info-Block */
    .section-title{
      margin:1.25rem 0 .6rem;
      font-size:1.1rem;
      font-weight:700;
    }
    .hint{
      margin-top:14px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:12px 14px;
    }
    .hint-title{font-weight:800;margin:0 0 6px 0}
    .hint p{margin:0;color:var(--text-muted);line-height:1.4}
    .hint a{color:var(--primary);font-weight:700;text-decoration:none}
    .hint a:hover{text-decoration:underline}
    .smallnote{color:var(--text-muted);font-size:12px;margin-top:6px}

    /* Meta-Text statt Pills */
    .meta{
      font-size:.9rem;
      color:var(--text-muted);
      margin:.2rem 0 1.0rem;
    }
    .meta.error{color:var(--danger);font-weight:600}

    hr.sep{
      margin:1.4rem 0 1.0rem;
      border:0;
      border-top:1px solid var(--border);
    }

    /* Footer wie Hauptseite (zentrierte Links) */
    footer{
      margin-top:.2rem;
      font-size:.85rem;
      color:var(--text-muted);
    }
    .footer-buttons{
      display:flex;
      justify-content:center;
      gap:2.5rem;
      margin-top:.2rem;
      margin-bottom:.1rem;
      flex-wrap:wrap;
    }
    .footer-link{
      font-size:1.05rem;
      font-weight:600;
      color:var(--text-muted);
      text-decoration:underline;
      text-underline-offset:3px;
      cursor:pointer;
    }
    .footer-link:hover{color:var(--text-main)}

    @media (max-width:600px){
      .page{margin:1.25rem auto 2rem;padding:0 .75rem}
      .card{padding:1.25rem 1.1rem 1.8rem;border-radius:12px}
      .logo-wrapper img{border-radius:8px}
      .intro h1{font-size:1.25rem}
      .footer-buttons{gap:1.8rem}
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">

      <div class="header">
        <div class="logo-wrapper">
          <img src="https://netteck.de/Logos/logo_name.jpeg" alt="Kevin Strakerjahn Networks &amp; Automation" />
        </div>
      </div>

      <div class="intro">
        <h1>Statusabfrage</h1>
        <p>Hier sehen Sie, in welchem Schritt sich Ihr Auftrag aktuell befindet.</p>
      </div>

      <div class="meta" id="metaText">Wird geladen …</div>

      <div class="section-title">Fortschritt</div>
      <ul class="status-list" id="statusList"></ul>

      <div class="hint" id="maintenanceHint" style="display:none;">
        <div class="hint-title">Wartungsvertrag möglich</div>
        <p>
          Wenn Sie keinen Wartungsvertrag haben, können Sie mit Ihrer Abschlussrechnung einen Wartungsvertrag anfragen – innerhalb von <b>2&nbsp;Monaten</b> nach Abschluss der Arbeiten.<br/>
          <a href="https://netteck.de/aktuelles/enercon_kundenrouter_wartung/vertrag_anfragen/" target="_blank" rel="noopener">Wartungsvertrag anfragen</a>
        </p>
        <div class="smallnote">Hinweis: Die Anzeige basiert auf dem zuletzt gemeldeten Status aus unserem System.</div>
      </div>

      <hr class="sep" />

      <footer>
        <div class="footer-buttons">
          <a class="footer-link" href="https://netteck.de/">Start</a>
          <a class="footer-link" href="https://netteck.de/kontakt/">Kontakt</a>
          <a class="footer-link" href="https://netteck.de/impressum/">Impressum</a>
          <a class="footer-link" href="https://netteck.de/datenschutz/">Datenschutz</a>
        </div>
      </footer>

    </div>
  </div>

<script>
(() => {
  const FLOW_URL = "https://default91b0e232846941aab7d1176f14ecb7.8c.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cdb4fe11b1ec4734b92faa10692eceee/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=5vIxBWiAsZLxsVc1WkWfaIMwl4RSjW3IJ6bmVK_EcbY";

  const STEPS = [
    { key: "Angebot erstellt", desc: "Das Angebot wurde erstellt und wird Ihnen bereitgestellt." },
    { key: "Angebot angenommen", desc: "Ihr Angebot wurde bestätigt – die Umsetzung wird eingeplant." },
    { key: "Abschlagsrechnung erstellt", desc: "Die Abschlagsrechnung für Material wurde erstellt." },
    { key: "Abschlagsrechnung gezahlt", desc: "Zahlungseingang ist verbucht – Material kann bestellt werden." },
    { key: "Material bestellt", desc: "Material wurde bestellt bzw. ist im Zulauf." },
    { key: "Router vorbereitet", desc: "Router wird vorkonfiguriert und für den Einbau vorbereitet." },
    { key: "Router installiert", desc: "Router wurde installiert bzw. der Einbau ist erfolgt." },
    { key: "Dokumentation erstellt", desc: "Dokumentation/Übergabeunterlagen werden erstellt." },
    { key: "Rechnung erstellt", desc: "Abschlussrechnung wurde erstellt." },
    { key: "Rechnung bezahlt", desc: "Zahlungseingang der Abschlussrechnung ist verbucht." }
  ];

  const MAINTENANCE = [
    { key: "Kein Wartungsvertrag", desc: "Aktuell ist kein Wartungsvertrag hinterlegt." },
    { key: "Wartungsvertrag aktiv", desc: "Es besteht ein aktiver Wartungsvertrag." },
    { key: "Wartungsvertrag beendet", desc: "Der Wartungsvertrag wurde beendet." }
  ];

  const $list = document.getElementById("statusList");
  const $meta = document.getElementById("metaText");
  const $hint = document.getElementById("maintenanceHint");

  function getToken() {
    // 1) /status/<token>
    const parts = window.location.pathname.split("/").filter(Boolean);
    const last = parts[parts.length - 1] || "";
    const guidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    if (guidRe.test(last)) return last;

    // 2) #<token>
    const hash = (window.location.hash || "").replace("#","").trim();
    if (guidRe.test(hash)) return hash;

    // 3) ?t=<token> (Fallback)
    const q = new URLSearchParams(window.location.search);
    const t = (q.get("t") || "").trim();
    if (guidRe.test(t)) return t;

    return "";
  }

  function render(statusValue){
    $list.innerHTML = "";

    const idx = STEPS.findIndex(s => s.key === statusValue);

    STEPS.forEach((s, i) => {
      const li = document.createElement("li");
      li.className = "status-item";

      // alles bis inkl. aktuellem Status = erledigt/grün
      const done = (idx !== -1) && (i <= idx);
      if (done) li.classList.add("is-done");

      li.innerHTML = `
        <div class="row">
          <div class="left">
            <span class="dot" aria-hidden="true"></span>
            <div class="status-title">${s.key}</div>
          </div>
          <div class="badge">${done ? "Erledigt" : "Offen"}</div>
        </div>
        <div class="status-desc">${s.desc}</div>
      `;
      $list.appendChild(li);
    });

    // Wartungsvertrag Überschrift
    const header = document.createElement("li");
    header.className = "status-item";
    header.innerHTML = `
      <div class="row">
        <div class="left">
          <span class="dot" aria-hidden="true" style="background: rgba(107,114,128,.45)"></span>
          <div class="status-title">Wartungsvertrag</div>
        </div>
        <div class="badge">Info</div>
      </div>
      <div class="status-desc">Dieser Abschnitt zeigt den Wartungsvertrags-Status (falls bereits hinterlegt).</div>
    `;
    $list.appendChild(header);

    // Wartungsvertrag Status (nur markieren wenn der Flow genau einen dieser Werte liefert)
    MAINTENANCE.forEach((s) => {
      const li = document.createElement("li");
      li.className = "status-item";
      const isThis = (statusValue === s.key);
      if (isThis) li.classList.add("is-done");

      li.innerHTML = `
        <div class="row">
          <div class="left">
            <span class="dot" aria-hidden="true"></span>
            <div class="status-title">${s.key}</div>
          </div>
          <div class="badge">${isThis ? "Erledigt" : "—"}</div>
        </div>
        <div class="status-desc">${s.desc}</div>
      `;
      $list.appendChild(li);
    });

    // Hinweis nur wenn "Kein Wartungsvertrag"
    $hint.style.display = (statusValue === "Kein Wartungsvertrag") ? "block" : "none";
  }

  async function load(){
    const token = getToken();
    if(!token){
      $meta.classList.add("error");
      $meta.textContent = "Kein gültiger Token in der URL gefunden.";
      render("");
      return;
    }

    try{
      $meta.classList.remove("error");
      $meta.textContent = "Status wird abgerufen …";

      const res = await fetch(FLOW_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ token })
      });

      if(!res.ok){
        const text = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${res.statusText}${text ? " – " + text : ""}`);
      }

      const data = await res.json().catch(()=> ({}));
      const statusValue = (data && (data.Value || data.value || data.status || data.Status)) || "";

      if(!statusValue){
        $meta.classList.add("error");
        $meta.textContent = "Kein Status empfangen.";
        render("");
        return;
      }

      $meta.textContent = `Aktueller Status: ${statusValue}`;
      render(statusValue);
    }catch(e){
      $meta.classList.add("error");
      $meta.textContent = "Fehler bei der Statusabfrage.";
      render("");
      console.error(e);
    }
  }

  load();
})();
</script>
</body>
</html>
